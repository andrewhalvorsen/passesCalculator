<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pass Pricing — Blocks</title>
<style>
  :root{--yellow:#fff36a;--ink:#111827;--accent:#2563eb;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:#f8fafc;color:var(--ink)}
  .wrap{max-width:1100px;margin:16px auto;background:#fff;border:1px solid var(--border);
        border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06)}

  /* Top bar */
  .bar{background:#d9d9d9;padding:6px 12px;font-weight:700;letter-spacing:.08em;color:#444;
       display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .bar .left,.bar .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
  .pill{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;border-radius:999px;font-size:12px;font-weight:600}
  .pill.inline{padding:4px 8px}

  /* Master summary */
  .card{border-top:1px solid var(--border)}
  .header{background:var(--yellow);padding:12px 12px;text-align:center;border-bottom:1px solid var(--border)}
  .header h1{margin:0;font-size:22px;font-weight:800}

  .inputs{padding:8px 12px;background:#fff}

  /* Strict horizontal control row */
  .controls-row{
    display:flex;align-items:flex-end;gap:8px;flex-wrap:nowrap;
    overflow-x:auto;white-space:nowrap;padding-bottom:2px
  }
  .controls-row > *{flex:0 0 auto}

  /* Master Pass Control */
  .group{display:flex;flex-direction:column;gap:4px;min-width:max-content}
  .group .label{font-size:11px;color:#374151;font-weight:700;letter-spacing:.02em;margin-left:2px}
  .row-controls{display:flex;gap:6px;align-items:center}
  .pill-btn{
    display:inline-flex;align-items:center;gap:6px;
    background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9999px;
    padding:6px 10px;font-weight:700;color:#111827;white-space:nowrap;cursor:pointer
  }
  .pill-btn:active{transform:translateY(1px)}

  /* Compact chips (Months, Min $/acre, $/pin) */
  .chip{
    display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9999px;
    padding:4px 8px;font-weight:600;white-space:nowrap
  }
  .chip label{font-size:11px;color:#374151}
  .chip input{width:70px;font-size:13px;padding:3px 6px;border:1px solid #d1d5db;border-radius:8px;outline:none}
  .chip input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}

  /* Edit bar */
  .editbar{display:flex;align-items:center;gap:8px;justify-content:flex-end;padding:4px 12px}
  .editbar .mini{font-size:12px}
  .editbar select,.editbar input[type=number]{padding:4px 6px;border:1px solid #d1d5db;border-radius:8px}
  .editbar .btn{padding:4px 8px;font-size:12px}

  .muted{color:#6b7280}

  /* Tables (tight) */
  .grid{width:100%;border-collapse:collapse;margin:6px 0 10px}
  .grid th,.grid td{border:1px solid var(--border);padding:8px 10px;text-align:right;font-variant-numeric:tabular-nums}
  .grid th:first-child,.grid td:first-child{text-align:center}
  .grid thead th{background:#eef2ff;font-weight:700}
  .grid tfoot td{background:#f3f4f6;font-weight:700;vertical-align:top}
  .row-hi{background:var(--yellow)}
  .notice{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;padding:8px 10px;border-radius:10px;display:none;margin:0 12px 8px}

  /* Blocks (tight spacing) */
  .blocks{padding:0 12px 10px}
  .block{border:none;border-radius:12px;margin:4px 0;overflow:hidden;transition:opacity .2s ease, filter .2s ease}
  .inactive{opacity:.55; filter:grayscale(.4)}
  .collapsed .block-body{display:none}

  /* Collapsible header pill — darker brown, no border */
  .title{background:#fff;padding:0}
  .toggle-zone{
    margin:4px;
    display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:#6f4a2c;border:none;border-radius:9999px;padding:8px 12px;
    cursor:pointer;outline:none;color:#fff;box-shadow:none;-webkit-tap-highlight-color:transparent
  }
  .toggle-zone:focus{outline:none;box-shadow:none}
  .toggle-zone .muted{color:rgba(255,255,255,.9)}
  .tz-left{display:flex;align-items:center;gap:10px;font-weight:800}
  .tz-right{display:flex;align-items:center;gap:12px}
  .switch{display:flex;align-items:center;gap:6px;font-size:12px}
  .switch input{transform:scale(1.05)}

  /* Block internals (still tight) */
  .block .inputs{padding:6px 10px}
  .block .controls-row{gap:6px}
  .block .chip{padding:4px 8px;margin-right:6px}
  .block .chip:last-child{margin-right:0}
  .block .chip input{width:68px;font-size:13px;padding:3px 6px}
  .block .row-controls{gap:6px}
  .block .pill-btn{padding:6px 10px}

  .foot{display:flex;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid var(--border);background:#fff}

  /* Customer view */
  .cust-hide{display:block}
  body.customer .cust-hide{display:none !important}
  body.customer .blocks{display:none !important}
  .col-adj-peracre,.col-hours,.col-adj-total{display:table-cell}
  body.customer .col-adj-peracre,
  body.customer .col-hours,
  body.customer .col-adj-total{display:none}

  /* Inputs inside master table when editing */
  .edit-input{width:110px}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="left">
      <div>NAME</div>
      <label style="display:flex;align-items:center;gap:6px;font-weight:600;cursor:pointer">
        <input type="checkbox" id="customerToggle" />
        <span>Customer view</span>
      </label>
    </div>
    <div class="right">
      <span class="pill inline" id="blockCountPill">Blocks: 0 (active 0)</span>
      <button class="btn" id="addBlockBtn" type="button">+ Add Block</button>
    </div>
  </div>

  <!-- MASTER SUMMARY -->
  <div class="card" id="masterCard">
    <div class="header"><h1>All Blocks — Summary</h1></div>
    <div id="masterErr" class="notice"></div>

    <!-- EXACT ORDER: [Master Pass Control] [Months] [Min $/acre] [$ / pin] -->
    <div class="inputs">
      <div class="controls-row">
        <div class="group cust-hide">
          <div class="label">Master Pass Control</div>
          <div class="row-controls">
            <button class="pill-btn" id="masterRemovePass" type="button">− Pass All</button>
            <button class="pill-btn" id="masterAddPass" type="button">+ Pass All</button>
          </div>
        </div>

        <div class="chip cust-hide">
          <label for="masterMonths">Months</label>
          <input id="masterMonths" type="number" min="1" max="12" step="1" />
        </div>
        <div class="chip cust-hide">
          <label for="masterFloor">Min $/acre</label>
          <input id="masterFloor" type="number" min="0" step="0.01" value="20" />
        </div>
        <div class="chip cust-hide">
          <label for="masterDpp">$ / pin</label>
          <input id="masterDpp" type="number" min="0" step="0.01" value="20" />
        </div>
      </div>
    </div>

    <!-- Edit controls -->
    <div class="editbar cust-hide">
      <button class="btn" id="editToggle" type="button">Edit</button>
      <div class="mini">Edit by:</div>
      <select id="editBy">
        <option value="total" selected>Total</option>
        <option value="peracre">Cost / Acre</option>
      </select>
      <button class="btn" id="editSave" type="button" style="display:none">Save</button>
      <button class="btn" id="editCancel" type="button" style="display:none">Cancel</button>
    </div>

    <div class="muted" id="masterAcreInfoMuted" style="padding:0 12px 6px">Included acres: — • Included pins: —</div>

    <div style="padding:0 12px 0">
      <table class="grid">
        <thead>
          <tr>
            <th style="width:150px">Blocks Contributing</th>
            <th style="width:120px">Pass</th>
            <th>Cost / Acre</th>
            <th class="col-adj-peracre">Adjusted Cost / Acre</th>
            <th class="col-hours">Hours</th>
            <th>Total Cost</th>
            <th class="col-adj-total">Adjusted Total Cost</th>
          </tr>
        </thead>
        <tbody id="masterPassRows"></tbody>
        <tfoot>
          <tr>
            <td id="masterBlocksCell" style="text-align:center" class="muted">—</td>
            <td style="text-align:center"># of Passes</td>
            <td id="masterPassesCell" style="text-align:center" class="muted">—</td>
            <td class="col-adj-peracre"></td>
            <td id="masterHoursCell" class="col-hours" style="text-align:right">— h</td>
            <td id="masterGrandCell" style="text-align:right"><div id="masterBaseTotal">$—</div></td>
            <td id="masterAdjCell" class="col-adj-total" style="text-align:right">
              <span class="pill inline" id="masterAdjTotalPill">Adjusted Total: $—</span>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="foot" style="justify-content:flex-start">
      <span class="muted">Payment plan:</span>
      <span class="pill inline" id="masterPaymentPill">—</span>
    </div>
  </div>

  <!-- BLOCKS -->
  <div class="blocks" id="blocks"></div>
</div>

<script>
"use strict";

/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const fmtUSD = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0);
const round2 = v => Math.round((Number(v||0) + Number.EPSILON) * 100) / 100;
const clamp  = (n,min,max) => Math.min(max, Math.max(min, n));
function equalPayments(total, n){
  n = Math.max(1, Math.trunc(n||1));
  const each = round2(total / n);
  const list = Array.from({length:n-1}, ()=> each);
  list.push(round2(total - list.reduce((a,b)=>a+b,0)));
  return list;
}

/* ========= Core calc ========= */
function calcBase(pinCount, acres, dollarsPerPin){
  if (!Number.isFinite(pinCount) || Math.trunc(pinCount)!==pinCount || pinCount<0) throw new Error('Pin count must be a whole number >= 0');
  if (!(acres>0)) throw new Error('Acres must be > 0');
  if (!(dollarsPerPin>=0)) throw new Error('Price per pin must be >= 0');
  const basePerAcre = (pinCount*dollarsPerPin)/acres;
  const autoCount = basePerAcre < 50 ? 4 : (basePerAcre < 100 ? 5 : 6); // 100 => 6
  return { basePerAcre, autoCount };
}
function calcWithCount(pinCount, acres, passCount, floorPerAcre, dollarsPerPin, overrides){
  const { basePerAcre } = calcBase(pinCount, acres, dollarsPerPin);
  const passes = [];
  let prev = basePerAcre;
  for (let i=1;i<=passCount;i++){
    let rate = (i===1) ? basePerAcre : (prev/2);
    if (overrides && overrides[i] != null) rate = Number(overrides[i]);
    let floored = false;
    if (rate < floorPerAcre){ rate = floorPerAcre; floored = true; }
    passes.push({ number:i, perAcre:rate, floored });
    prev = rate; // subsequent halves use possibly overridden/floored rate
  }
  const perAcreTotal = passes.reduce((s,p)=>s+p.perAcre,0);
  const fieldTotal   = round2(perAcreTotal * acres);
  return { basePerAcre, passCount, passes, perAcreTotal, fieldTotal };
}

/* ========= State ========= */
let blocks = []; // {id,pins,acres,include,removedPasses,addedPasses,collapsed,overrides?:{[pass]:rate}}
let blockSeq = 1;
let masterMonthsTouched = false;

const editState = { active:false, by:'total' };

/* ========= Block template ========= */
function blockHTML(b){
  return `
  <div class="block${b.collapsed?' collapsed':''}" data-block-id="${b.id}">
    <div class="title">
      <div class="toggle-zone" id="toggle-zone-${b.id}" tabindex="0" role="button" aria-expanded="${!b.collapsed}">
        <div class="tz-left">
          <span>Block ${b.id} — <span id="pillHours-${b.id}">0.00</span> h</span>
        </div>
        <div class="tz-right">
          <span class="muted" id="hdrPins-${b.id}">Pins: —</span>
          <span class="muted" id="hdrAcres-${b.id}">Acres: —</span>
          <span class="muted" id="effectiveFloor-${b.id}"></span>
          <span class="muted" id="effectiveDpp-${b.id}"></span>
          <label class="switch" id="include-wrap-${b.id}">
            <input type="checkbox" id="include-${b.id}" ${b.include?'checked':''}>
            <span>Include in totals</span>
          </label>
        </div>
      </div>
    </div>

    <div class="block-body">
      <div id="err-${b.id}" class="notice"></div>

      <div class="inputs">
        <div class="controls-row">
          <!-- Pills inside each block -->
          <div class="chip">
            <label for="pins-${b.id}">Pins</label>
            <input id="pins-${b.id}" type="number" min="0" step="1" value="${b.pins}">
          </div>
          <div class="chip">
            <label for="acres-${b.id}">Acres</label>
            <input id="acres-${b.id}" type="number" min="0" step="0.01" value="${b.acres}">
          </div>
          <div class="chip">
            <label for="floor-${b.id}">Min $/acre</label>
            <input id="floor-${b.id}" type="number" min="0" step="0.01" placeholder="">
          </div>
          <div class="chip">
            <label for="dpp-${b.id}">$ / pin</label>
            <input id="dpp-${b.id}" type="number" min="0" step="0.01" placeholder="">
          </div>

          <div class="row-controls" style="margin-left:8px">
            <button class="pill-btn" id="removePass-${b.id}" type="button">− Remove 1 Pass</button>
            <button class="pill-btn" id="addPass-${b.id}" type="button">+ Add 1 Pass</button>
          </div>
        </div>
      </div>

      <div style="padding:6px 10px;display:flex;gap:6px;flex-wrap:wrap">
        <span class="pill inline" id="base-${b.id}">Base: $— / acre</span>
        <span class="pill inline" id="passcount-${b.id}">Passes: —</span>
        <span class="pill inline" id="total-${b.id}">Whole-field total: $—</span>
      </div>

      <div style="padding:0 10px 0">
        <table class="grid">
          <thead>
            <tr>
              <th style="width:120px">Pass</th>
              <th>Cost / Acre</th>
              <th>Hours (total ÷ 180)</th>
              <th>Total Cost (this pass × acres)</th>
            </tr>
          </thead>
          <tbody id="rows-${b.id}"></tbody>
          <tfoot>
            <tr>
              <td style="text-align:center"># of Passes</td>
              <td id="passesCell-${b.id}" class="muted" style="text-align:center">—</td>
              <td id="hoursCell-${b.id}" style="text-align:right">— h</td>
              <td id="grandCell-${b.id}" style="text-align:right">$—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>`;
}

/* ========= Editing / reverse engineering ========= */
function clearMasterError(){ const e=$('#masterErr'); if(e){e.style.display='none'; e.textContent='';} }
function setMasterError(msg){ const e=$('#masterErr'); if(e){ e.style.display='block'; e.textContent=msg; } }

function gatherPassContext(passIndex){
  const ctx = []; // {b, acres, effFloor, effDpp, passCount, rate}
  for (const b of blocks){
    if (!b.include) continue;
    const floorIn = $(`#floor-${b.id}`), dppIn = $(`#dpp-${b.id}`);
    const effFloor = (floorIn && floorIn.value!=='' && Number.isFinite(Number(floorIn.value)) && Number(floorIn.value)>=0)
      ? round2(Number(floorIn.value)) : (Number($('#masterFloor').value)||20);
    const effDpp   = (dppIn && dppIn.value!=='' && Number.isFinite(Number(dppIn.value)) && Number(dppIn.value)>=0)
      ? round2(Number(dppIn.value)) : (Number($('#masterDpp').value)||20);
    const pins  = Math.trunc(Number($(`#pins-${b.id}`).value||0));
    const acres = Number($(`#acres-${b.id}`).value||0);
    const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
    const passCount = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
    if (passIndex > passCount) continue;
    const q = calcWithCount(pins, acres, passCount, effFloor, effDpp, b.overrides);
    const rate = q.passes[passIndex-1].perAcre;
    ctx.push({ b, acres, effFloor, rate });
  }
  return ctx;
}

/* scale to target total, respecting floors; writes overrides */
function distributePassToTarget(passIndex, targetTotal){
  clearMasterError();
  const ctx = gatherPassContext(passIndex);
  if (ctx.length===0) return;
  const sumCur    = ctx.reduce((s,x)=> s + x.rate * x.acres, 0);
  const sumFloors = ctx.reduce((s,x)=> s + x.effFloor * x.acres, 0);

  if (targetTotal < sumFloors - 0.01){
    setMasterError(`Target for Pass ${passIndex} is below minimum floors (${fmtUSD(sumFloors)}). Using floors instead.`);
    for (const x of ctx) setOverride(x.b, passIndex, x.effFloor);
    return;
  }

  let f = sumCur>0 ? (targetTotal / sumCur) : 1;
  for (const x of ctx){ x.newRate = Math.max(x.effFloor, round2(x.rate * f)); }
  let achieved = ctx.reduce((s,x)=> s + x.newRate * x.acres, 0);

  // iterative correction to hit target within a cent
  for (let iter=0; iter<10 && Math.abs(achieved - targetTotal) > 0.01; iter++){
    const delta = targetTotal - achieved;
    const free = delta >= 0
      ? ctx              // can increase everyone
      : ctx.filter(x => x.newRate > x.effFloor + 1e-9); // can only decrease those above floor
    if (free.length===0) break;
    const sumA = free.reduce((s,x)=> s + x.acres, 0) || 1;
    const dPerAcre = delta / sumA;
    for (const x of free){
      x.newRate = Math.max(x.effFloor, round2(x.newRate + dPerAcre));
    }
    achieved = ctx.reduce((s,x)=> s + x.newRate * x.acres, 0);
  }

  for (const x of ctx) setOverride(x.b, passIndex, x.newRate);
}

function setOverride(b, passIndex, rate){
  if (!b.overrides) b.overrides = {};
  b.overrides[passIndex] = round2(rate);
}

/* ========= Rendering ========= */
function renderAll(){
  try{
    const floor = (n => (Number.isFinite(n)&&n>=0?round2(n):20))(Number($('#masterFloor').value));
    const dpp   = (n => (Number.isFinite(n)&&n>=0?round2(n):20))(Number($('#masterDpp').value));
    let adjPct  = Math.trunc(Number($('#masterAdjPct')?.value)); if (!Number.isFinite(adjPct)) adjPct = 0;
    const adjFactor = 1 + (adjPct/100);
    const customerMode = document.body.classList.contains('customer');

    const editBy = editState.by;
    $('#editSave').style.display   = editState.active ? 'inline-block' : 'none';
    $('#editCancel').style.display = editState.active ? 'inline-block' : 'none';
    $('#editToggle').textContent   = editState.active ? 'Editing…' : 'Edit';
    $('#editBy').disabled          = !editState.active;

    const masterRows = []; // each index: { total, acres, contrib, perAcre }
    let totalActiveAcres = 0, activeBlocks = 0, includedPins = 0;

    for (const b of blocks){
      const err = $(`#err-${b.id}`);
      const include = $(`#include-${b.id}`).checked;
      b.include = include;
      document.querySelector(`.block[data-block-id="${b.id}"]`).classList.toggle('inactive', !include);

      try{
        if (err) err.style.display='none';

        const pins  = Math.trunc(Number($(`#pins-${b.id}`).value));
        const acres = Number($(`#acres-${b.id}`).value);

        const floorIn = $(`#floor-${b.id}`), dppIn = $(`#dpp-${b.id}`);
        const effFloor = (floorIn.value!=='' && Number.isFinite(Number(floorIn.value)) && Number(floorIn.value)>=0) ? round2(Number(floorIn.value)) : floor;
        const effDpp   = (dppIn.value!=='' && Number.isFinite(Number(dppIn.value))   && Number(dppIn.value)  >=0) ? round2(Number(dppIn.value))   : dpp;

        // Update header pill meta
        $(`#hdrPins-${b.id}`).textContent  = `Pins: ${Number.isFinite(pins)?pins:'—'}`;
        $(`#hdrAcres-${b.id}`).textContent = `Acres: ${Number.isFinite(acres)?round2(acres).toFixed(2):'—'}`;
        $(`#effectiveFloor-${b.id}`).textContent = `Floor: ${fmtUSD(effFloor)}/acre`;
        $(`#effectiveDpp-${b.id}`).textContent   = `$/pin: ${fmtUSD(effDpp)}`;

        const base = calcBase(pins, acres, effDpp);
        let passCount = base.autoCount + (b.addedPasses||0) - (b.removedPasses||0);
        passCount = clamp(passCount,1,8);

        const q = calcWithCount(pins, acres, passCount, effFloor, effDpp, b.overrides);

        const hoursForPill = q.passes.reduce((s,p)=> s + round2((p.perAcre*acres)/180), 0);
        $(`#pillHours-${b.id}`).textContent = hoursForPill.toFixed(2);
        $(`#base-${b.id}`).textContent      = `Base: ${fmtUSD(round2(base.basePerAcre))} / acre`;
        $(`#passcount-${b.id}`).textContent = `Passes: ${q.passCount}`;
        $(`#total-${b.id}`).textContent     = `Whole-field total: ${fmtUSD(q.fieldTotal)}`;

        const tbody = $(`#rows-${b.id}`); tbody.innerHTML = '';
        let blockHours = 0;
        for (const p of q.passes){
          const passTotal = round2(p.perAcre * acres);
          const hours     = round2(passTotal / 180);
          blockHours += hours;

          const tr = document.createElement('tr');
          if (p.number===1) tr.classList.add('row-hi');
          tr.innerHTML = `
            <td style="text-align:center">Pass ${p.number}${p.floored?' *':''}</td>
            <td>${fmtUSD(round2(p.perAcre))}</td>
            <td>${hours.toFixed(2)} h</td>
            <td>${fmtUSD(passTotal)}</td>`;
          tbody.appendChild(tr);

          if (include){
            const idx = p.number-1;
            if (!masterRows[idx]) masterRows[idx] = { total:0, acres:0, contrib:0 };
            masterRows[idx].total   += passTotal;
            masterRows[idx].acres   += acres;
            masterRows[idx].contrib += 1;
          }
        }
        $(`#passesCell-${b.id}`).textContent = q.passCount;
        $(`#hoursCell-${b.id}`).textContent  = `${blockHours.toFixed(2)} h`;
        $(`#grandCell-${b.id}`).textContent  = fmtUSD(q.fieldTotal);

        if (include){ totalActiveAcres += acres; includedPins += pins; activeBlocks++; }
      }catch(inner){
        if (err){ err.style.display='block'; err.textContent = inner.message; }
        console.error(inner);
      }
    }

    $('#blockCountPill').textContent = `Blocks: ${blocks.length} (active ${activeBlocks})`;
    $('#masterAcreInfoMuted').textContent = `Included acres: ${round2(totalActiveAcres)} • Included pins: ${includedPins}`;

    // Master table
    const mBody = $('#masterPassRows'); mBody.innerHTML = '';
    let baseTotal = 0, masterHours = 0;
    for (let i=0;i<masterRows.length;i++){
      const row = masterRows[i]; if (!row) continue;
      const baseRowTotal = round2(row.total);
      const perAcre = row.acres>0 ? round2(baseRowTotal/row.acres) : 0;
      const hoursPass = round2(baseRowTotal/180);
      const adjPerAcre = round2(perAcre * adjFactor);
      const adjRowTotal= round2(baseRowTotal * adjFactor);
      baseTotal += baseRowTotal; masterHours += hoursPass;
      const displayTotal = customerMode ? adjRowTotal : baseRowTotal;
      const contribText = `${row.contrib||0}/${activeBlocks}`;

      const tr = document.createElement('tr');

      const perAcreCell = editState.active && editBy==='peracre'
        ? `<input class="edit-input edit-peracre" data-pass="${i+1}" type="number" step="0.01" value="${perAcre}">`
        : fmtUSD(perAcre);

      const totalCell = editState.active && editBy==='total'
        ? `<input class="edit-input edit-total" data-pass="${i+1}" type="number" step="0.01" value="${baseRowTotal}">`
        : fmtUSD(displayTotal);

      tr.innerHTML = `
        <td style="text-align:center">${contribText}</td>
        <td style="text-align:center">Pass ${i+1}</td>
        <td>${perAcreCell}</td>
        <td class="col-adj-peracre">${fmtUSD(adjPerAcre)}</td>
        <td class="col-hours">${hoursPass.toFixed(2)} h</td>
        <td>${totalCell}</td>
        <td class="col-adj-total">${fmtUSD(adjRowTotal)}</td>`;
      if (i===0) tr.classList.add('row-hi');
      mBody.appendChild(tr);
    }
    $('#masterPassesCell').textContent = masterRows.length || '—';
    $('#masterHoursCell').textContent  = `${masterHours.toFixed(2)} h`;
    $('#masterBlocksCell').textContent = `${activeBlocks}/${blocks.length}`;

    // Months & payments
    const monthsEl = $('#masterMonths');
    let months = Number(monthsEl.value);
    const maxPass = masterRows.length || 1;
    if (!masterMonthsTouched || !Number.isFinite(months)){ months = maxPass; monthsEl.value = months; }
    months = clamp(Math.trunc(months), 1, 12); if (String(months)!==monthsEl.value) monthsEl.value = months;

    const adjTotal = round2(baseTotal * (1 + (adjPct/100)));
    $('#masterBaseTotal').textContent = fmtUSD(document.body.classList.contains('customer') ? adjTotal : round2(baseTotal));
    $('#masterAdjTotalPill').textContent = `Adjusted Total: ${fmtUSD(adjTotal)}`;

    const payments = equalPayments(adjTotal, months);
    $('#masterPaymentPill').textContent = `${months} payments of ${fmtUSD(payments[0]||0)}`;
  }catch(e){
    console.error(e);
  }
}

/* ========= Blocks ========= */
function addNewBlock({pins=0, acres=1, collapsed=true}={}){
  const id = blockSeq++;
  const b = { id, pins:Math.trunc(pins), acres:(acres>0?acres:1), include:true, removedPasses:0, addedPasses:0, collapsed, overrides:{} };
  blocks.push(b);
  $('#blocks').insertAdjacentHTML('beforeend', blockHTML(b));
  renderAll();
}

/* ========= Events ========= */
function wireEvents(){
  // Customer view toggle
  $('#customerToggle').addEventListener('change', (e)=>{
    document.body.classList.toggle('customer', e.target.checked);
    renderAll();
  });

  // Master chips
  $('#masterMonths').addEventListener('input', ()=>{ masterMonthsTouched = true; renderAll(); });
  $('#masterFloor').addEventListener('input', renderAll);
  $('#masterDpp').addEventListener('input', renderAll);

  // Edit controls
  $('#editToggle').addEventListener('click', ()=>{
    editState.active = !editState.active;
    clearMasterError();
    renderAll();
  });
  $('#editBy').addEventListener('change', (e)=>{ editState.by = e.target.value; renderAll(); });
  $('#editCancel').addEventListener('click', ()=>{
    editState.active = false;
    clearMasterError();
    renderAll();
  });
  $('#editSave').addEventListener('click', ()=>{
    try{
      clearMasterError();
      const by = editState.by;
      if (by==='total'){
        document.querySelectorAll('.edit-total').forEach(inp=>{
          const passIndex = Number(inp.dataset.pass);
          const val = Number(inp.value);
          if (Number.isFinite(val)) distributePassToTarget(passIndex, val);
        });
      }else{
        document.querySelectorAll('.edit-peracre').forEach(inp=>{
          const passIndex = Number(inp.dataset.pass);
          const perAcre = Number(inp.value);
          if (!Number.isFinite(perAcre)) return;
          // total acres contributing to this pass
          const ctx = gatherPassContext(passIndex);
          const sumAcres = ctx.reduce((s,x)=> s + x.acres, 0);
          const targetTotal = round2(perAcre * sumAcres);
          distributePassToTarget(passIndex, targetTotal);
        });
      }
    }finally{
      editState.active = false;
      renderAll();
    }
  });

  // Master pass control
  $('#masterRemovePass').addEventListener('click', ()=>{
    for (const b of blocks){ b.removedPasses = (b.removedPasses||0)+1; }
    renderAll();
  });
  $('#masterAddPass').addEventListener('click', ()=>{
    for (const b of blocks){ b.addedPasses = (b.addedPasses||0)+1; }
    renderAll();
  });

  // Add block
  $('#addBlockBtn').addEventListener('click', ()=> addNewBlock({pins:0, acres:1, collapsed:true}));

  // Blocks delegation
  const blocksEl = $('#blocks');
  blocksEl.addEventListener('click', (e)=>{
    if (e.target.closest('.switch')) { setTimeout(renderAll, 0); return; }
    const btn = e.target.closest('button');
    if (btn && btn.id.startsWith('addPass-')){
      const id = Number(btn.id.replace('addPass-',''));
      const b = blocks.find(x=>x.id===id); if (!b) return;
      const pins  = Math.trunc(Number($(`#pins-${id}`).value||0));
      const acres = Number($(`#acres-${id}`).value||0);
      const dppIn = $(`#dpp-${id}`).value;
      const mdpp  = Number($('#masterDpp').value||20);
      const effDpp= (dppIn!=='' && Number.isFinite(Number(dppIn))) ? Number(dppIn) : mdpp;
      const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff   = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
      if (eff < 8) b.addedPasses = (b.addedPasses||0)+1;
      renderAll(); return;
    }
    if (btn && btn.id.startsWith('removePass-')){
      const id = Number(btn.id.replace('removePass-',''));
      const b = blocks.find(x=>x.id===id); if (!b) return;
      const pins  = Math.trunc(Number($(`#pins-${id}`).value||0));
      const acres = Number($(`#acres-${id}`).value||0);
      const dppIn = $(`#dpp-${id}`).value;
      const mdpp  = Number($('#masterDpp').value||20);
      const effDpp= (dppIn!=='' && Number.isFinite(Number(dppIn))) ? Number(dppIn) : mdpp;
      const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff   = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
      if (eff > 1){
        if ((b.addedPasses||0)>0) b.addedPasses -= 1;
        else b.removedPasses = (b.removedPasses||0) + 1;
      }
      renderAll(); return;
    }
    const tz = e.target.closest('.toggle-zone');
    if (tz){
      const id = Number(tz.id.replace('toggle-zone-',''));
      const blockEl = document.querySelector(`.block[data-block-id="${id}"]`);
      const collapsed = blockEl.classList.toggle('collapsed');
      tz.setAttribute('aria-expanded', String(!collapsed));
      return;
    }
  });
  blocksEl.addEventListener('input', (e)=>{ if (/^(pins-|acres-|floor-|dpp-)/.test(e.target.id)) renderAll(); });
  blocksEl.addEventListener('change', (e)=>{ if (/^(pins-|acres-|floor-|dpp-|include-)/.test(e.target.id)) renderAll(); });
}

/* ========= Boot ========= */
(function start(){
  wireEvents();
  addNewBlock({ pins:400, acres:54, collapsed:false });
})();
</script>
</body>
</html>
