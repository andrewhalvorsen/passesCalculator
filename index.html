<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pass Pricing — Blocks</title>
<style>
  :root{--yellow:#fff36a;--ink:#111827;--accent:#2563eb;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:#f8fafc;color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;background:#fff;border:1px solid var(--border);
        border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .bar{background:#d9d9d9;padding:8px 16px;font-weight:700;letter-spacing:.08em;color:#444;
       display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .bar .right{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .header{background:var(--yellow);padding:18px 16px;text-align:center;border-bottom:2px solid var(--border)}
  .header h1{margin:0;font-size:28px;font-weight:800}
  .card{border-top:1px solid var(--border)}
  .pill{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;border-radius:999px;font-size:12px;font-weight:600}
  .pill.inline{padding:6px 10px}

  .inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
          gap:16px;padding:16px;background:#fff}
  .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
  .field label{display:block;font-size:12px;color:#6b7280;letter-spacing:.04em;margin-bottom:6px}
  .field input{width:100%;font-size:18px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;outline:none}
  .field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .hint{font-size:11px;color:#6b7280;margin-top:6px}
  .muted{color:#6b7280}
  .grid{width:100%;border-collapse:collapse;margin:8px 0 16px}
  .grid th,.grid td{border:1px solid var(--border);padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums}
  .grid th:first-child,.grid td:first-child{text-align:center}
  .grid thead th{background:#eef2ff;font-weight:700}
  .grid tfoot td{background:#f3f4f6;font-weight:700;vertical-align:top}
  .row-hi{background:var(--yellow)}
  .notice{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;display:none;margin:0 16px 12px}

  .blocks{padding:0 16px 24px}
  .block{border:1px solid var(--border);border-radius:12px;margin:16px 0;overflow:hidden;transition:opacity .2s ease, filter .2s ease}
  .inactive{opacity:.55; filter:grayscale(.4)}
  .collapsed .block-body{display:none}
  .row-controls{display:flex;gap:8px;align-items:center}

  /* Header: white background; pill is outline-only (no fill) */
  .title{background:#fff;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .toggle-zone{
    flex:1;display:flex;align-items:center;justify-content:space-between;gap:12px;
    background:transparent;border:1px solid #d1d5db;border-radius:9999px;padding:10px 14px;
    cursor:pointer;outline:none;color:#111827;
  }
  .toggle-zone:hover{background:transparent}
  .toggle-zone:focus{box-shadow:0 0 0 3px rgba(100,116,139,.25)}
  .tz-left{display:flex;align-items:center;gap:10px;font-weight:700}
  .tz-right{display:flex;align-items:center;gap:14px}
  .switch{display:flex;align-items:center;gap:6px;font-size:12px}
  .switch input{transform:scale(1.1)}

  .adj-inline{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .adj-controls{display:flex;align-items:center;gap:8px}
  .adj-controls input{max-width:110px}

  .foot{display:flex;align-items:center;gap:12px;padding:14px 24px;border-top:2px solid var(--border);background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div>NAME</div>
    <div class="right">
      <span class="pill inline" id="blockCountPill">Blocks: 0 (active 0)</span>
      <button class="btn" id="addBlockBtn">+ Add Block</button>
    </div>
  </div>

  <div class="card" id="masterCard">
    <div class="header"><h1>All Blocks — Summary</h1></div>
    <div id="masterErr" class="notice"></div>

    <div class="inputs">
      <div class="field">
        <label for="masterMonths">Months (payments for ALL blocks)</label>
        <input id="masterMonths" type="number" min="1" max="12" step="1" />
        <div class="hint">Auto = max pass count across included blocks; override 1–12.</div>
      </div>
      <div class="field">
        <label for="masterFloor">Minimum $/acre (floor)</label>
        <input id="masterFloor" type="number" min="0" step="0.01" value="20" />
      </div>
      <div class="field">
        <label for="masterDpp">Price per pin ($/pin)</label>
        <input id="masterDpp" type="number" min="0" step="0.01" value="20" />
      </div>
      <div class="field">
        <label>Master Pass Control</label>
        <div class="row-controls">
          <button class="btn" id="masterRemovePass">− Pass All</button>
          <button class="btn" id="masterAddPass">+ Pass All</button>
        </div>
        <div class="hint">Min 1, Max 8 passes per block.</div>
      </div>
    </div>

    <div class="muted" id="masterAcreInfoMuted" style="padding:0 16px 8px">Included acres: —</div>

    <div style="padding:0 16px 0">
      <table class="grid">
        <thead>
          <tr>
            <th style="width:120px">Pass</th>
            <th>Cost / Acre</th>
            <th>Adjusted Cost / Acre</th>
            <th>Hours</th>
            <th>Total Cost</th>
            <th>Adjusted Total Cost</th>
          </tr>
        </thead>
        <tbody id="masterPassRows"></tbody>
        <tfoot>
          <tr>
            <td style="text-align:center"># of Passes</td>
            <td id="masterPassesCell" style="text-align:center" class="muted">—</td>
            <td></td>
            <td id="masterHoursCell" style="text-align:right">— h</td>
            <td id="masterGrandCell" style="text-align:right"><div id="masterBaseTotal">$—</div></td>
            <td id="masterAdjCell" style="text-align:right">
              <div class="adj-inline">
                <span class="pill inline" id="masterAdjTotalPill">Adjusted Total: $—</span>
                <div class="adj-controls">
                  <button class="btn" id="adjMinus">−1%</button>
                  <input id="masterAdjPct" type="number" step="1" min="-100" max="100" value="0" />
                  <button class="btn" id="adjPlus">+1%</button>
                </div>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="foot" style="justify-content:flex-start">
      <span class="muted">Payment plan:</span>
      <span class="pill inline" id="masterPaymentPill">—</span>
    </div>
  </div>

  <div class="blocks" id="blocks"></div>
</div>

<script>
(function(){
  /* ===== Utils ===== */
  const fmtUSD = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0);
  const round2 = v => Math.round((Number(v||0) + Number.EPSILON)*100)/100;
  const clamp  = (n,min,max) => Math.min(max, Math.max(min, n));
  function equalPayments(total,n){ n=Math.max(1,Math.trunc(n||1));
    const each=round2(total/n), list=Array.from({length:n-1},()=>each);
    list.push(round2(total - list.reduce((a,b)=>a+b,0))); return list; }

  /* ===== Core calc ===== */
  function calcBase(pinCount, acres, dollarsPerPin){
    if (!Number.isFinite(pinCount) || Math.trunc(pinCount)!==pinCount || pinCount<0) throw new Error('Pin count must be a whole number >= 0');
    if (!(acres>0)) throw new Error('Acres must be > 0');
    if (!(dollarsPerPin>=0)) throw new Error('Price per pin must be >= 0');
    const basePerAcre=(pinCount*dollarsPerPin)/acres;
    const autoCount = basePerAcre < 50 ? 4 : (basePerAcre < 100 ? 5 : 6); // 100 exactly -> 6
    return { basePerAcre, autoCount };
  }
  function calcWithCount(pinCount, acres, passCount, floorPerAcre, dollarsPerPin){
    const { basePerAcre } = calcBase(pinCount, acres, dollarsPerPin);
    const passes=[]; let prev=basePerAcre;
    for(let i=1;i<=passCount;i++){
      let rate = (i===1)?basePerAcre:(prev/2); let floored=false;
      if(rate<floorPerAcre){ rate=floorPerAcre; floored=true; }
      prev=rate; passes.push({number:i, perAcre:rate, floored});
    }
    const perAcreTotal=passes.reduce((s,p)=>s+p.perAcre,0);
    const fieldTotal=round2(perAcreTotal*acres);
    return { basePerAcre, passCount, passes, perAcreTotal, fieldTotal };
  }

  /* ===== State ===== */
  let blocks=[]; // {id,pins,acres,include,removedPasses,addedPasses,collapsed}
  let blockSeq=1;
  let masterMonthsTouched=false;

  /* ===== Templates ===== */
  function blockTemplate(b){
    const el=document.createElement('div');
    el.className='block'+(b.collapsed?' collapsed':''); el.dataset.blockId=b.id;
    el.innerHTML=`
      <div class="title">
        <div class="toggle-zone" id="toggle-zone-${b.id}" tabindex="0" role="button" aria-expanded="${!b.collapsed}">
          <div class="tz-left">
            <span>Block ${b.id} — <span id="pillHours-${b.id}">0.00</span> h</span>
          </div>
          <div class="tz-right">
            <span class="muted" id="effectiveFloor-${b.id}"></span>
            <span class="muted" id="effectiveDpp-${b.id}"></span>
            <label class="switch" id="include-wrap-${b.id}">
              <input type="checkbox" id="include-${b.id}" ${b.include?'checked':''}>
              <span>Include in totals</span>
            </label>
          </div>
        </div>
      </div>
      <div class="block-body">
        <div id="err-${b.id}" class="notice"></div>
        <div class="inputs">
          <div class="field">
            <label for="pins-${b.id}">Pin Count (whole number)</label>
            <input id="pins-${b.id}" type="number" min="0" step="1" value="${b.pins}" />
          </div>
          <div class="field">
            <label for="acres-${b.id}">Acres (fractional allowed)</label>
            <input id="acres-${b.id}" type="number" min="0" step="0.01" value="${b.acres}" />
          </div>
          <div class="field">
            <label for="floor-${b.id}">Min $/acre (optional override)</label>
            <input id="floor-${b.id}" type="number" min="0" step="0.01" placeholder="">
            <div class="hint">Leave blank to use master floor.</div>
          </div>
          <div class="field">
            <label for="dpp-${b.id}">$ per pin (optional override)</label>
            <input id="dpp-${b.id}" type="number" min="0" step="0.01" placeholder="">
            <div class="hint">Leave blank to use master $/pin.</div>
          </div>
          <div class="field">
            <label>Passes (add/remove)</label>
            <div class="row-controls">
              <button class="btn" id="removePass-${b.id}">− Remove 1 Pass</button>
              <button class="btn" id="addPass-${b.id}">+ Add 1 Pass</button>
            </div>
            <div class="hint">Min 1, max 8.</div>
          </div>
        </div>
        <div style="padding:10px 16px;display:flex;gap:10px;flex-wrap:wrap">
          <span class="pill inline" id="base-${b.id}">Base: $— / acre</span>
          <span class="pill inline" id="passcount-${b.id}">Passes: —</span>
          <span class="pill inline" id="total-${b.id}">Whole-field total: $—</span>
        </div>
        <div style="padding:0 16px 0">
          <table class="grid">
            <thead>
              <tr>
                <th style="width:120px">Pass</th>
                <th>Cost / Acre</th>
                <th>Hours (total ÷ 180)</th>
                <th>Total Cost (this pass × acres)</th>
              </tr>
            </thead>
            <tbody id="rows-${b.id}"></tbody>
            <tfoot>
              <tr>
                <td style="text-align:center"># of Passes</td>
                <td id="passesCell-${b.id}" class="muted" style="text-align:center">—</td>
                <td id="hoursCell-${b.id}" style="text-align:right">— h</td>
                <td id="grandCell-${b.id}" style="text-align:right">$—</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>`;
    return el;
  }

  /* ===== Render ===== */
  function renderAll(){
    const masterFloorEl=document.getElementById('masterFloor');
    const masterDppEl=document.getElementById('masterDpp');
    const masterAdjEl=document.getElementById('masterAdjPct');

    let masterFloor=round2(Number(masterFloorEl&&masterFloorEl.value)); if(!Number.isFinite(masterFloor)||masterFloor<0) masterFloor=20;
    let masterDpp  =round2(Number(masterDppEl&&masterDppEl.value));     if(!Number.isFinite(masterDpp)||masterDpp<0) masterDpp=20;
    let masterAdjPct=Math.trunc(Number(masterAdjEl&&masterAdjEl.value)); if(!Number.isFinite(masterAdjPct)) masterAdjPct=0;
    masterAdjPct=clamp(masterAdjPct,-100,100); if(masterAdjEl&&String(masterAdjPct)!==masterAdjEl.value) masterAdjEl.value=masterAdjPct;
    const adjFactor=1+(masterAdjPct/100);

    const masterRows=[]; let totalActiveAcres=0, activeBlocks=0;

    for(const b of blocks){
      const includeChk=document.getElementById(`include-${b.id}`);
      const blockEl=document.querySelector(`.block[data-block-id="${b.id}"]`);
      b.include=!!(includeChk&&includeChk.checked);
      if(blockEl) blockEl.classList.toggle('inactive',!b.include);

      const err=document.getElementById(`err-${b.id}`);
      try{
        if(err) err.style.display='none';

        const pins = Math.trunc(Number((document.getElementById(`pins-${b.id}`)||{}).value));
        const acres= Number((document.getElementById(`acres-${b.id}`)||{}).value);

        const floorIn=document.getElementById(`floor-${b.id}`);
        let floorVal=Number(floorIn&&floorIn.value);
        const hasFloorOverride=Number.isFinite(floorVal)&& (floorIn&&floorIn.value!=='');
        if(!hasFloorOverride) floorVal=masterFloor;
        floorVal=clamp(round2(floorVal),0,1e9);
        const ef=document.getElementById(`effectiveFloor-${b.id}`); if(ef) ef.textContent=`Floor: ${fmtUSD(floorVal)}/acre`;
        if(floorIn) floorIn.placeholder=String(masterFloor);

        const dppIn=document.getElementById(`dpp-${b.id}`);
        let dppVal=Number(dppIn&&dppIn.value);
        const hasDppOverride=Number.isFinite(dppVal)&&(dppIn&&dppIn.value!=='');
        if(!hasDppOverride) dppVal=masterDpp;
        dppVal=clamp(round2(dppVal),0,1e9);
        const ed=document.getElementById(`effectiveDpp-${b.id}`); if(ed) ed.textContent=`$/pin: ${fmtUSD(dppVal)}`;
        if(dppIn) dppIn.placeholder=String(masterDpp);

        const base=calcBase(pins, acres, dppVal);
        const effPasses=clamp((base.autoCount+(b.addedPasses||0)-(b.removedPasses||0)),1,8);
        const q=calcWithCount(pins, acres, effPasses, floorVal, dppVal);

        const pillHours=document.getElementById(`pillHours-${b.id}`);
        if(pillHours){
          const h=q.passes.reduce((s,p)=>s+round2((p.perAcre*acres)/180),0);
          pillHours.textContent=h.toFixed(2);
        }
        const baseP=document.getElementById(`base-${b.id}`); if(baseP) baseP.textContent=`Base: ${fmtUSD(round2(base.basePerAcre))} / acre`;
        const pcP=document.getElementById(`passcount-${b.id}`); if(pcP) pcP.textContent=`Passes: ${q.passCount}`;
        const totP=document.getElementById(`total-${b.id}`); if(totP) totP.textContent=`Whole-field total: ${fmtUSD(q.fieldTotal)}`;

        const tbody=document.getElementById(`rows-${b.id}`); if(tbody) tbody.innerHTML='';
        let hoursSum=0;
        for(const p of q.passes){
          const passTotal=round2(p.perAcre*acres);
          const hours=round2(passTotal/180);
          hoursSum+=hours;
          if(tbody){
            const tr=document.createElement('tr');
            if(p.number===1) tr.classList.add('row-hi');
            tr.innerHTML=`
              <td style="text-align:center">Pass ${p.number}${p.floored?' *':''}</td>
              <td>${fmtUSD(round2(p.perAcre))}</td>
              <td>${hours.toFixed(2)} h</td>
              <td>${fmtUSD(passTotal)}</td>`;
            tbody.appendChild(tr);
          }
          if(b.include){
            const idx=p.number-1;
            masterRows[idx]=masterRows[idx]||{total:0, acres:0};
            masterRows[idx].total+=passTotal;
            masterRows[idx].acres+=acres;
          }
        }
        const pcCell=document.getElementById(`passesCell-${b.id}`); if(pcCell) pcCell.textContent=q.passCount;
        const hCell=document.getElementById(`hoursCell-${b.id}`); if(hCell) hCell.textContent=`${hoursSum.toFixed(2)} h`;
        const gCell=document.getElementById(`grandCell-${b.id}`); if(gCell) gCell.textContent=fmtUSD(q.fieldTotal);

        if(b.include){ totalActiveAcres+=acres; activeBlocks++; }
      }catch(e){
        if(err){ err.style.display='block'; err.textContent=e.message; }
      }
    }

    document.getElementById('blockCountPill').textContent=`Blocks: ${blocks.length} (active ${activeBlocks})`;

    const masterMonthsInput=document.getElementById('masterMonths');
    let mVal=Number(masterMonthsInput&&masterMonthsInput.value);
    const maxPass=masterRows.length||1;
    if(!masterMonthsTouched||!Number.isFinite(mVal)){ mVal=maxPass; if(masterMonthsInput) masterMonthsInput.value=mVal; }
    mVal=clamp(Math.trunc(mVal),1,12);
    if(masterMonthsInput && masterMonthsInput.value!==String(mVal)) masterMonthsInput.value=mVal;

    const mBody=document.getElementById('masterPassRows'); if(mBody) mBody.innerHTML='';
    let baseTotal=0, masterHours=0;
    for(let i=0;i<masterRows.length;i++){
      const row=masterRows[i]; if(!row) continue;
      const baseRowTotal=round2(row.total);
      const perAcre=row.acres>0?round2(baseRowTotal/row.acres):0;
      const hoursPass=round2(baseRowTotal/180);
      const adjPerAcre=round2(perAcre*adjFactor);
      const adjRowTotal=round2(baseRowTotal*adjFactor);
      baseTotal+=baseRowTotal; masterHours+=hoursPass;

      if(mBody){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="text-align:center">Pass ${i+1}</td>
          <td>${fmtUSD(perAcre)}</td>
          <td>${fmtUSD(adjPerAcre)}</td>
          <td>${hoursPass.toFixed(2)} h</td>
          <td>${fmtUSD(baseRowTotal)}</td>
          <td>${fmtUSD(adjRowTotal)}</td>`;
        if(i===0) tr.classList.add('row-hi');
        mBody.appendChild(tr);
      }
    }

    document.getElementById('masterAcreInfoMuted').textContent=`Included acres: ${round2(totalActiveAcres)}`;
    document.getElementById('masterPassesCell').textContent=masterRows.length||'—';
    document.getElementById('masterHoursCell').textContent=`${masterHours.toFixed(2)} h`;
    document.getElementById('masterBaseTotal').textContent=fmtUSD(round2(baseTotal));

    const adjTotal=round2(baseTotal*adjFactor);
    document.getElementById('masterAdjTotalPill').textContent=`Adjusted Total: ${fmtUSD(adjTotal)}`;
    const payments=equalPayments(adjTotal, mVal);
    document.getElementById('masterPaymentPill').textContent=`${mVal} payments of ${fmtUSD(payments[0]||0)}`;
  }

  /* ===== Blocks ===== */
  function addNewBlock({pins=0, acres=1, collapsed=true}={}){
    const id=blockSeq++;
    const b={id, pins:Math.trunc(pins), acres:(acres>0?acres:1), include:true, removedPasses:0, addedPasses:0, collapsed};
    blocks.push(b);

    const el=blockTemplate(b);
    document.getElementById('blocks').appendChild(el);

    ['input','change'].forEach(e=>{
      document.getElementById(`pins-${id}`).addEventListener(e, renderAll);
      document.getElementById(`acres-${id}`).addEventListener(e, renderAll);
      document.getElementById(`floor-${id}`).addEventListener(e, renderAll);
      document.getElementById(`dpp-${id}`).addEventListener(e, renderAll);
    });

    document.getElementById(`removePass-${id}`).addEventListener('click', ()=>{
      const bb=blocks.find(x=>x.id===id);
      const pins=Math.trunc(Number(document.getElementById(`pins-${id}`).value||0));
      const acres=Number(document.getElementById(`acres-${id}`).value||0);
      const dpp=Number(document.getElementById(`dpp-${id}`).value);
      const mdpp=Number(document.getElementById('masterDpp').value||20);
      const effDpp=(Number.isFinite(dpp)&&document.getElementById(`dpp-${id}`).value!=='')?dpp:mdpp;
      const base=calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff=clamp(base.autoCount+(bb.addedPasses||0)-(bb.removedPasses||0),1,8);
      if(eff>1){
        if((bb.addedPasses||0)>0) bb.addedPasses-=1; else bb.removedPasses=(bb.removedPasses||0)+1;
        renderAll();
      }
    });
    document.getElementById(`addPass-${id}`).addEventListener('click', ()=>{
      const bb=blocks.find(x=>x.id===id);
      const pins=Math.trunc(Number(document.getElementById(`pins-${id}`).value||0));
      const acres=Number(document.getElementById(`acres-${id}`).value||0);
      const dpp=Number(document.getElementById(`dpp-${id}`).value);
      const mdpp=Number(document.getElementById('masterDpp').value||20);
      const effDpp=(Number.isFinite(dpp)&&document.getElementById(`dpp-${id}`).value!=='')?dpp:mdpp;
      const base=calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff=clamp(base.autoCount+(bb.addedPasses||0)-(bb.removedPasses||0),1,8);
      if(eff<8){ bb.addedPasses=(bb.addedPasses||0)+1; renderAll(); }
    });

    // Include checkbox shouldn't toggle collapse
    document.getElementById(`include-wrap-${id}`).addEventListener('click', e=>e.stopPropagation());
    document.getElementById(`include-${id}`).addEventListener('click', e=>{ e.stopPropagation(); renderAll(); });
    document.getElementById(`include-${id}`).addEventListener('change', renderAll);

    // Collapsible header
    const tz=document.getElementById(`toggle-zone-${id}`);
    const toggle=()=>{ const blockEl=document.querySelector(`.block[data-block-id="${id}"]`);
      const c=blockEl.classList.toggle('collapsed'); tz.setAttribute('aria-expanded', String(!c)); };
    tz.addEventListener('click', toggle);
    tz.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); } });

    renderAll();
  }

  /* ===== Init (robust) ===== */
  function init(){
    // Wire globals
    document.getElementById('addBlockBtn').addEventListener('click', ()=> addNewBlock({pins:0, acres:1, collapsed:true}));
    document.getElementById('masterMonths').addEventListener('input', ()=>{ masterMonthsTouched=true; renderAll(); });
    document.getElementById('masterMonths').addEventListener('change', ()=>{ masterMonthsTouched=true; renderAll(); });
    ['masterFloor','masterDpp','masterAdjPct'].forEach(id=>{
      const el=document.getElementById(id); el.addEventListener('input', renderAll); el.addEventListener('change', renderAll);
    });
    document.getElementById('adjMinus').addEventListener('click', ()=>{
      const i=document.getElementById('masterAdjPct'); i.value=clamp((Number(i.value)||0)-1,-100,100); renderAll();
    });
    document.getElementById('adjPlus').addEventListener('click', ()=>{
      const i=document.getElementById('masterAdjPct'); i.value=clamp((Number(i.value)||0)+1,-100,100); renderAll();
    });
    document.getElementById('masterAddPass').addEventListener('click', ()=>{
      blocks.forEach(b=>{
        const pins=Math.trunc(Number(document.getElementById(`pins-${b.id}`).value||0));
        const acres=Number(document.getElementById(`acres-${b.id}`).value||0);
        const dpp=Number(document.getElementById(`dpp-${b.id}`).value);
        const mdpp=Number(document.getElementById('masterDpp').value||20);
        const effDpp=(Number.isFinite(dpp)&&document.getElementById(`dpp-${b.id}`).value!=='')?dpp:mdpp;
        const base=calcBase(pins, Math.max(0.01, acres), effDpp);
        const eff=clamp(base.autoCount+(b.addedPasses||0)-(b.removedPasses||0),1,8);
        if(eff<8) b.addedPasses=(b.addedPasses||0)+1;
      }); renderAll();
    });
    document.getElementById('masterRemovePass').addEventListener('click', ()=>{
      blocks.forEach(b=>{
        const pins=Math.trunc(Number(document.getElementById(`pins-${b.id}`).value||0));
        const acres=Number(document.getElementById(`acres-${b.id}`).value||0);
        const dpp=Number(document.getElementById(`dpp-${b.id}`).value);
        const mdpp=Number(document.getElementById('masterDpp').value||20);
        const effDpp=(Number.isFinite(dpp)&&document.getElementById(`dpp-${b.id}`).value!=='')?dpp:mdpp;
        const base=calcBase(pins, Math.max(0.01, acres), effDpp);
        const eff=clamp(base.autoCount+(b.addedPasses||0)-(b.removedPasses||0),1,8);
        if(eff>1){ if((b.addedPasses||0)>0) b.addedPasses-=1; else b.removedPasses=(b.removedPasses||0)+1; }
      }); renderAll();
    });

    // Seed one visible block
    addNewBlock({pins:400, acres:54, collapsed:false});
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init(); // if script is at end and DOM already parsed
  }
})();
</script>
</body>
</html>
