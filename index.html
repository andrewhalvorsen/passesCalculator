<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pass Pricing — Blocks</title>
<style>
  /* ===== Palette based on your mock ===== */
  :root{
    --surface:#ffffff;
    --bg:#f4f6f3;
    --ink:#112015;

    --forest:#1f3823;          /* dark panel/pill */
    --forest-2:#2a4a30;        /* alt dark */
    --olive:#5b7f2a;           /* darker action */
    --olive-2:#496420;         /* darker hover/border */
    --chip-bg:#eef3ea;         /* input chip bg */
    --chip-border:#d7e0cf;
    --table-head:#e9f2e4;
    --border:#dfe7d8;
    --yellow:#e8f29b;          /* subtle highlight for pass 1 */
  }

  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    margin:0;background:var(--bg);color:var(--ink)
  }
  .wrap{
    max-width:1100px;margin:16px auto;background:var(--surface);
    border:1px solid var(--border);border-radius:14px;overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.06)
  }

  /* ===== Top bar ===== */
  .bar{
    background:var(--forest);color:#fff;
    padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap
  }
  .bar .left,.bar .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{
    border:1px solid var(--olive-2);background:var(--olive);color:#fff;
    border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer;font-weight:700;line-height:1
  }
  .btn:hover{background:var(--olive-2)}

  .pill{
    background:#e7f1dc;color:#234018;border:1px solid #cfe0b8;border-radius:999px;font-size:12px;font-weight:700
  }
  .pill.inline{padding:4px 10px}

  /* ===== Master summary ===== */
  .card{border-top:1px solid var(--border)}
  .header{background:var(--forest-2);padding:14px 12px;text-align:center}
  .header h1{margin:0;font-size:22px;font-weight:800;color:#fff}

  .inputs{padding:8px 12px;background:var(--surface)}
  .controls-row{
    display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;white-space:nowrap;overflow-x:auto;padding-bottom:2px
  }
  .controls-row>*{flex:0 0 auto}

  .group{display:flex;flex-direction:column;gap:4px;min-width:max-content}
  .group .label{font-size:11px;color:#14301b;font-weight:800;letter-spacing:.02em}
  .row-controls{display:flex;gap:8px;align-items:center}
  .pill-btn{
    display:inline-flex;align-items:center;gap:6px;
    background:var(--olive);border:1px solid var(--olive-2);color:#fff;
    border-radius:9999px;padding:8px 12px;font-weight:800;cursor:pointer;line-height:1
  }
  .pill-btn:hover{background:var(--olive-2)}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--chip-bg);border:1px solid var(--chip-border);border-radius:9999px;
    padding:6px 10px;font-weight:700;color:#1e3a22
  }
  .chip label{font-size:11px;opacity:.85}
  .chip input{
    width:80px;font-size:13px;padding:4px 8px;border:1px solid #c9d5c2;border-radius:8px;background:#fff;outline:none
  }

  /* Edit inline block (below Master Pass Control, left) */
  .edit-under{display:flex;align-items:center;gap:8px;margin:8px 0 0 0}
  .edit-inline{display:none;align-items:center;gap:8px}
  .edit-inline .muted{display:inline-flex;align-items:center;font-weight:700;opacity:.9}
  .edit-inline select{
    padding:6px 8px;height:32px;border:1px solid #c9d5c2;border-radius:8px;background:#fff;color:#102312
  }

  .muted{color:#4a5d4c}

  /* ===== Tables ===== */
  .grid{width:100%;border-collapse:collapse;margin:6px 0 10px}
  .grid th,.grid td{border:1px solid var(--border);padding:9px 10px;text-align:right;font-variant-numeric:tabular-nums}
  .grid th:first-child,.grid td:first-child{text-align:center}
  .grid thead th{background:var(--table-head);font-weight:800;color:#1d3522}
  .grid tfoot td{background:#f3f7ef;font-weight:800}
  .row-hi{background:var(--yellow)}
  .notice{color:#7a1111;background:#fef2f2;border:1px solid #fecaca;padding:8px 10px;border-radius:10px;display:none;margin:0 12px 8px}

  /* ===== Blocks ===== */
  .blocks{padding:0 12px 12px}
  .block{border:none;border-radius:12px;margin:6px 0;overflow:hidden;transition:opacity .2s ease, filter .2s ease}
  .inactive{opacity:.55; filter:grayscale(.4)}
  .collapsed .block-body{display:none}

  /* Block pill header */
  .title{background:var(--surface);padding:0}
  .toggle-zone{
    margin:6px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    background:var(--forest);border:none;border-radius:9999px;padding:10px 14px;
    cursor:pointer;color:#fff;user-select:none
  }
  .toggle-zone .muted{color:rgba(255,255,255,.9)}
  .tz-left{display:flex;align-items:center;gap:10px;font-weight:900}
  .tz-right{display:flex;align-items:center;gap:12px}
  .switch{display:flex;align-items:center;gap:6px;font-size:12px}
  .switch input{transform:scale(1.05)}

  /* Block internals */
  .block .inputs{padding:8px 10px}
  .block .controls-row{gap:8px}
  .block .chip{padding:6px 10px}
  .block .chip input{width:78px}
  .block .row-controls{gap:8px}
  .block .pill-btn{padding:8px 12px}

  .foot{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border-top:1px solid var(--border);background:var(--surface)}
  .foot-topline{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="left">
      <div style="font-weight:900;letter-spacing:.02em">SERVICES PAGE</div>
      <label style="display:flex;align-items:center;gap:6px;font-weight:700;cursor:pointer;margin-left:6px">
        <input type="checkbox" id="customerToggle" />
        <span>Customer view</span>
      </label>
    </div>
    <div class="right">
      <span class="pill inline" id="blockCountPill">Blocks: 0 (active 0)</span>
      <button class="btn" id="addBlockBtn" type="button">Add New Service</button>
    </div>
  </div>

  <!-- MASTER SUMMARY -->
  <div class="card" id="masterCard">
    <div class="header"><h1>All Blocks — Summary</h1></div>
    <div id="masterErr" class="notice"></div>

    <!-- One row: Master Pass Control, Months, Min/acre, $/pin -->
    <div class="inputs">
      <div class="controls-row">
        <div class="group cust-hide">
          <div class="label">Master Pass Control</div>
          <div class="row-controls">
            <button class="pill-btn" id="masterRemovePass" type="button">− Pass All</button>
            <button class="pill-btn" id="masterAddPass" type="button">+ Pass All</button>
          </div>
        </div>

        <div class="chip cust-hide">
          <label for="masterMonths">Months</label>
          <input id="masterMonths" type="number" min="1" max="12" step="1" />
        </div>
        <div class="chip cust-hide">
          <label for="masterFloor">Min $/acre</label>
          <input id="masterFloor" type="number" min="0" step="0.01" value="20" />
        </div>
        <div class="chip cust-hide">
          <label for="masterDpp">$ / pin</label>
          <input id="masterDpp" type="number" min="0" step="0.01" value="20" />
        </div>
      </div>

      <!-- Edit block sits BELOW the row, left aligned -->
      <div class="edit-under">
        <button class="pill-btn cust-hide" id="editToggle" type="button">Edit</button>
        <span id="editByWrap" class="edit-inline cust-hide">
          <span class="muted">Edit by</span>
          <select id="editBy">
            <option value="total" selected>Total</option>
            <option value="peracre">Cost / Acre</option>
          </select>
          <button class="pill-btn" id="editSave" type="button">Done</button>
          <button class="pill-btn" id="editCancel" type="button">Cancel</button>
        </span>
      </div>
    </div>

    <div style="padding:0 12px 0">
      <table class="grid">
        <thead>
          <tr>
            <th style="width:160px">Blocks Contributing</th>
            <th style="width:120px">Pass</th>
            <th>Cost / Acre</th>
            <th>Adjusted Cost / Acre</th>
            <th>Hours</th>
            <th>Total Cost</th>
            <th>Adjusted Total Cost</th>
          </tr>
        </thead>
        <tbody id="masterPassRows"></tbody>
        <tfoot>
          <tr>
            <td id="masterBlocksCell" style="text-align:center" class="muted">—</td>
            <td style="text-align:center"># of Passes</td>
            <td id="masterPassesCell" style="text-align:center" class="muted">—</td>
            <td></td>
            <td id="masterHoursCell" style="text-align:right">— h</td>
            <td id="masterGrandCell" style="text-align:right"><div id="masterBaseTotal">$—</div></td>
            <td id="masterAdjCell" style="text-align:right">
              <span class="pill inline" id="masterAdjTotalPill">Adjusted Total: $—</span>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Included pins/acres moved to the bottom, above payment plan -->
    <div class="foot">
      <div class="foot-topline">
        <span class="muted" id="masterAcreInfoMuted">Included acres: — • Included pins: —</span>
      </div>
      <div class="foot-topline">
        <span class="muted">Payment plan:</span>
        <span class="pill inline" id="masterPaymentPill">—</span>
      </div>
    </div>
  </div>

  <!-- BLOCKS -->
  <div class="blocks" id="blocks"></div>
</div>

<script>
"use strict";

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
const fmtUSD = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0);
const round2 = v => Math.round((Number(v||0) + Number.EPSILON) * 100) / 100;
const clamp  = (n,min,max) => Math.min(max, Math.max(min, n));
function equalPayments(total, n){
  n = Math.max(1, Math.trunc(n||1));
  const each = round2(total / n);
  const list = Array.from({length:n-1}, ()=> each);
  list.push(round2(total - list.reduce((a,b)=>a+b,0)));
  return list;
}

/* ===== Core calc ===== */
function calcBase(pinCount, acres, dollarsPerPin){
  if (!Number.isFinite(pinCount) || Math.trunc(pinCount)!==pinCount || pinCount<0) throw new Error('Pin count must be a whole number >= 0');
  if (!(acres>0)) throw new Error('Acres must be > 0');
  if (!(dollarsPerPin>=0)) throw new Error('Price per pin must be >= 0');
  const basePerAcre = (pinCount*dollarsPerPin)/acres;
  const autoCount = basePerAcre < 50 ? 4 : (basePerAcre < 100 ? 5 : 6); // 100 => 6
  return { basePerAcre, autoCount };
}
function calcWithCount(pinCount, acres, passCount, floorPerAcre, dollarsPerPin, overrides){
  const { basePerAcre } = calcBase(pinCount, acres, dollarsPerPin);
  const passes = [];
  let prev = basePerAcre;
  for (let i=1;i<=passCount;i++){
    let rate = (i===1) ? basePerAcre : (prev/2);
    if (overrides && overrides[i] != null) rate = Number(overrides[i]);
    let floored = false;
    if (rate < floorPerAcre){ rate = floorPerAcre; floored = true; }
    passes.push({ number:i, perAcre:rate, floored });
    prev = rate;
  }
  const perAcreTotal = passes.reduce((s,p)=>s+p.perAcre,0);
  const fieldTotal   = round2(perAcreTotal * acres);
  return { basePerAcre, passCount, passes, perAcreTotal, fieldTotal };
}

/* ===== State ===== */
let blocks = []; // {id,pins,acres,include,removedPasses,addedPasses,collapsed,overrides?:{[pass]:rate}}
let blockSeq = 1;
let masterMonthsTouched = false;
const editState = { active:false, by:'total' };

/* ===== Block template ===== */
function blockHTML(b){
  return `
  <div class="block${b.collapsed?' collapsed':''}" data-block-id="${b.id}">
    <div class="title">
      <div class="toggle-zone" id="toggle-zone-${b.id}" tabindex="0" role="button" aria-expanded="${!b.collapsed}">
        <div class="tz-left">
          <span class="pill-title">Block ${b.id}</span>
          <span class="pill-hours">— <span id="pillHours-${b.id}">0.00</span> h</span>
        </div>
        <div class="tz-right">
          <span class="muted pill-pins"  id="hdrPins-${b.id}">Pins: —</span>
          <span class="muted pill-acres" id="hdrAcres-${b.id}">Acres: —</span>
          <span class="muted pill-floor" id="effectiveFloor-${b.id}"></span>
          <span class="muted pill-dpp"   id="effectiveDpp-${b.id}"></span>
          <label class="switch" id="include-wrap-${b.id}">
            <input type="checkbox" id="include-${b.id}" ${b.include?'checked':''}>
            <span id="include-label-${b.id}">Include in totals</span>
          </label>
        </div>
      </div>
    </div>

    <div class="block-body">
      <div id="err-${b.id}" class="notice"></div>

      <div class="inputs">
        <div class="controls-row">
          <div class="chip">
            <label for="pins-${b.id}">Pins</label>
            <input id="pins-${b.id}" type="number" min="0" step="1" value="${b.pins}">
          </div>
          <div class="chip">
            <label for="acres-${b.id}">Acres</label>
            <input id="acres-${b.id}" type="number" min="0" step="0.01" value="${b.acres}">
          </div>
          <div class="chip">
            <label for="floor-${b.id}">Min $/acre</label>
            <input id="floor-${b.id}" type="number" min="0" step="0.01" placeholder="">
          </div>
          <div class="chip">
            <label for="dpp-${b.id}">$ / pin</label>
            <input id="dpp-${b.id}" type="number" min="0" step="0.01" placeholder="">
          </div>

          <div class="row-controls" style="margin-left:8px">
            <button class="pill-btn" id="removePass-${b.id}" type="button">− Remove 1 Pass</button>
            <button class="pill-btn" id="addPass-${b.id}" type="button">+ Add 1 Pass</button>
          </div>
        </div>
      </div>

      <div style="padding:6px 10px;display:flex;gap:6px;flex-wrap:wrap">
        <span class="pill inline" id="base-${b.id}">Base: $— / acre</span>
        <span class="pill inline" id="passcount-${b.id}">Passes: —</span>
        <span class="pill inline" id="total-${b.id}">Whole-field total: $—</span>
      </div>

      <div style="padding:0 10px 0">
        <table class="grid">
          <thead>
            <tr>
              <th style="width:120px">Pass</th>
              <th>Cost / Acre</th>
              <th>Hours</th>
              <th>Total Cost</th>
            </tr>
          </thead>
          <tbody id="rows-${b.id}"></tbody>
          <tfoot>
            <tr>
              <td style="text-align:center"># of Passes</td>
              <td id="passesCell-${b.id}" class="muted" style="text-align:center">—</td>
              <td id="hoursCell-${b.id}" style="text-align:right">— h</td>
              <td id="grandCell-${b.id}" style="text-align:right">$—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>`;
}

/* ===== Edit / reverse-engineer ===== */
function clearMasterError(){ const e=$('#masterErr'); if(e){e.style.display='none'; e.textContent='';} }
function setMasterError(msg){ const e=$('#masterErr'); if(e){ e.style.display='block'; e.textContent=msg; } }

function gatherPassContext(passIndex){
  const ctx = [];
  for (const b of blocks){
    if (!b.include) continue;
    const floorIn = $(`#floor-${b.id}`), dppIn = $(`#dpp-${b.id}`);
    const effFloor = (floorIn && floorIn.value!=='' && Number.isFinite(Number(floorIn.value)) && Number(floorIn.value)>=0)
      ? round2(Number(floorIn.value)) : (Number($('#masterFloor').value)||20);
    const effDpp   = (dppIn && dppIn.value!=='' && Number.isFinite(Number(dppIn.value)) && Number(dppIn.value)>=0)
      ? round2(Number(dppIn.value)) : (Number($('#masterDpp').value)||20);
    const pins  = Math.trunc(Number($(`#pins-${b.id}`).value||0));
    const acres = Number($(`#acres-${b.id}`).value||0);
    const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
    const passCount = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
    if (passIndex > passCount) continue;
    const q = calcWithCount(pins, acres, passCount, effFloor, effDpp, b.overrides);
    const rate = q.passes[passIndex-1].perAcre;
    ctx.push({ b, acres, effFloor, rate });
  }
  return ctx;
}
function distributePassToTarget(passIndex, targetTotal){
  clearMasterError();
  const ctx = gatherPassContext(passIndex);
  if (ctx.length===0) return;
  const sumCur    = ctx.reduce((s,x)=> s + x.rate * x.acres, 0);
  const sumFloors = ctx.reduce((s,x)=> s + x.effFloor * x.acres, 0);

  if (targetTotal < sumFloors - 0.01){
    setMasterError(`Target for Pass ${passIndex} is below floors (${fmtUSD(sumFloors)}). Using floors instead.`);
    for (const x of ctx) setOverride(x.b, passIndex, x.effFloor);
    return;
  }

  let f = sumCur>0 ? (targetTotal / sumCur) : 1;
  for (const x of ctx){ x.newRate = Math.max(x.effFloor, round2(x.rate * f)); }
  let achieved = ctx.reduce((s,x)=> s + x.newRate * x.acres, 0);

  for (let iter=0; iter<10 && Math.abs(achieved - targetTotal) > 0.01; iter++){
    const delta = targetTotal - achieved;
    const free = delta >= 0 ? ctx : ctx.filter(x => x.newRate > x.effFloor + 1e-9);
    if (free.length===0) break;
    const sumA = free.reduce((s,x)=> s + x.acres, 0) || 1;
    const dPerAcre = delta / sumA;
    for (const x of free){ x.newRate = Math.max(x.effFloor, round2(x.newRate + dPerAcre)); }
    achieved = ctx.reduce((s,x)=> s + x.newRate * x.acres, 0);
  }
  for (const x of ctx) setOverride(x.b, passIndex, x.newRate);
}
function setOverride(b, passIndex, rate){
  if (!b.overrides) b.overrides = {};
  b.overrides[passIndex] = round2(rate);
}

/* ===== Render ===== */
function renderAll(){
  try{
    const floor = (n => (Number.isFinite(n)&&n>=0?round2(n):20))(Number($('#masterFloor').value));
    const dpp   = (n => (Number.isFinite(n)&&n>=0?round2(n):20))(Number($('#masterDpp').value));
    let adjPct  = Math.trunc(Number($('#masterAdjPct')?.value)); if (!Number.isFinite(adjPct)) adjPct = 0;
    const customerMode = document.body.classList.contains('customer');

    // Edit UI show/hide (below Master Pass Control)
    $('#editByWrap').style.display = (editState.active ? 'inline-flex' : 'none');
    $('#editToggle').style.display = (editState.active ? 'none' : 'inline-flex');

    const masterRows = [];
    let totalActiveAcres = 0, activeBlocks = 0, includedPins = 0;

    for (const b of blocks){
      const err = $(`#err-${b.id}`);
      const include = $(`#include-${b.id}`).checked;
      b.include = include;
      const blockEl = document.querySelector(`.block[data-block-id="${b.id}"]`);
      blockEl.classList.toggle('inactive', !include);

      try{
        if (err) err.style.display='none';

        const pins  = Math.trunc(Number($(`#pins-${b.id}`).value));
        const acres = Number($(`#acres-${b.id}`).value);

        const floorIn = $(`#floor-${b.id}`), dppIn = $(`#dpp-${b.id}`);
        const effFloor = (floorIn.value!=='' && Number.isFinite(Number(floorIn.value)) && Number(floorIn.value)>=0) ? round2(Number(floorIn.value)) : floor;
        const effDpp   = (dppIn.value!=='' && Number.isFinite(Number(dppIn.value))   && Number(dppIn.value)  >=0) ? round2(Number(dppIn.value))   : dpp;

        // pill meta
        $(`#hdrPins-${b.id}`).textContent  = `Pins: ${Number.isFinite(pins)?pins:'—'}`;
        $(`#hdrAcres-${b.id}`).textContent = `Acres: ${Number.isFinite(acres)?round2(acres).toFixed(2):'—'}`;
        $(`#effectiveFloor-${b.id}`).textContent = `Floor: ${fmtUSD(effFloor)}/acre`;
        $(`#effectiveDpp-${b.id}`).textContent   = `$/pin: ${fmtUSD(effDpp)}`;

        const base = calcBase(pins, acres, effDpp);
        let passCount = base.autoCount + (b.addedPasses||0) - (b.removedPasses||0);
        passCount = clamp(passCount,1,8);

        const q = calcWithCount(pins, acres, passCount, effFloor, effDpp, b.overrides);

        const hoursForPill = q.passes.reduce((s,p)=> s + round2((p.perAcre*acres)/120), 0); // ÷120
        $(`#pillHours-${b.id}`).textContent = hoursForPill.toFixed(2);
        $(`#base-${b.id}`).textContent      = `Base: ${fmtUSD(round2(base.basePerAcre))} / acre`;
        $(`#passcount-${b.id}`).textContent = `Passes: ${q.passCount}`;
        $(`#total-${b.id}`).textContent     = `Whole-field total: ${fmtUSD(q.fieldTotal)}`;

        const tbody = $(`#rows-${b.id}`); tbody.innerHTML = '';
        let blockHours = 0;
        for (const p of q.passes){
          const passTotal = round2(p.perAcre * acres);
          const hours     = round2(passTotal / 120);  // ÷120
          blockHours += hours;

          const tr = document.createElement('tr');
          if (p.number===1) tr.classList.add('row-hi');
          tr.innerHTML = `
            <td style="text-align:center">Pass ${p.number}${p.floored?' *':''}</td>
            <td>${fmtUSD(round2(p.perAcre))}</td>
            <td>${hours.toFixed(2)} h</td>
            <td>${fmtUSD(passTotal)}</td>`;
          tbody.appendChild(tr);

          if (include){
            const idx = p.number-1;
            if (!masterRows[idx]) masterRows[idx] = { total:0, acres:0, contrib:0 };
            masterRows[idx].total   += passTotal;
            masterRows[idx].acres   += acres;
            masterRows[idx].contrib += 1;
          }
        }
        $(`#passesCell-${b.id}`).textContent = q.passCount;
        $(`#hoursCell-${b.id}`).textContent  = `${blockHours.toFixed(2)} h`;
        $(`#grandCell-${b.id}`).textContent  = fmtUSD(q.fieldTotal);

        if (include){ totalActiveAcres += acres; includedPins += pins; activeBlocks++; }
      }catch(inner){
        if (err){ err.style.display='block'; err.textContent = inner.message; }
        console.error(inner);
      }
    }

    $('#blockCountPill').textContent = `Blocks: ${blocks.length} (active ${activeBlocks})`;

    // master table
    const mBody = $('#masterPassRows'); mBody.innerHTML = '';
    let baseTotal = 0, masterHours = 0;
    for (let i=0;i<masterRows.length;i++){
      const row = masterRows[i]; if (!row) continue;
      const baseRowTotal = round2(row.total);
      const perAcre = row.acres>0 ? round2(baseRowTotal/row.acres) : 0;
      const hoursPass = round2(baseRowTotal/120); // ÷120
      const adjPerAcre = perAcre;
      const adjRowTotal= baseRowTotal;

      baseTotal += baseRowTotal; masterHours += hoursPass;

      const displayTotal = document.body.classList.contains('customer') ? adjRowTotal : baseRowTotal;
      const contribText = `${row.contrib||0}/${activeBlocks}`;

      const tr = document.createElement('tr');
      const perAcreCell = editState.active && editState.by==='peracre'
        ? `<input class="edit-input edit-peracre" data-pass="${i+1}" type="number" step="0.01" value="${perAcre}">`
        : fmtUSD(perAcre);
      const totalCell = editState.active && editState.by==='total'
        ? `<input class="edit-input edit-total" data-pass="${i+1}" type="number" step="0.01" value="${baseRowTotal}">`
        : fmtUSD(displayTotal);

      tr.innerHTML = `
        <td style="text-align:center">${contribText}</td>
        <td style="text-align:center">Pass ${i+1}</td>
        <td>${perAcreCell}</td>
        <td>${fmtUSD(adjPerAcre)}</td>
        <td>${hoursPass.toFixed(2)} h</td>
        <td>${totalCell}</td>
        <td>${fmtUSD(adjRowTotal)}</td>`;
      if (i===0) tr.classList.add('row-hi');
      mBody.appendChild(tr);
    }
    $('#masterPassesCell').textContent = masterRows.length || '—';
    $('#masterHoursCell').textContent  = `${masterHours.toFixed(2)} h`;
    $('#masterBlocksCell').textContent = `${activeBlocks}/${blocks.length}`;

    // included acres/pins now shown at bottom
    const includedPins = Array.from(document.querySelectorAll('[id^="hdrPins-"]')).reduce((sum, el, i)=>{
      const id = Number((el.id.match(/\d+$/)||[0])[0]);
      const include = document.querySelector(`#include-${id}`)?.checked;
      const pinsVal = parseInt(el.textContent.replace(/\D+/g,'')) || 0;
      return include ? sum + pinsVal : sum;
    }, 0);

    const includedAcres = Array.from(document.querySelectorAll('[id^="hdrAcres-"]')).reduce((sum, el, i)=>{
      const id = Number((el.id.match(/\d+$/)||[0])[0]);
      const include = document.querySelector(`#include-${id}`)?.checked;
      const acresText = el.textContent.split(':')[1]?.trim() || '0';
      const acresVal = Number(acresText) || 0;
      return include ? sum + acresVal : sum;
    }, 0);

    $('#masterAcreInfoMuted').textContent = `Included acres: ${round2(includedAcres)} • Included pins: ${includedPins}`;

    // months & payments
    const monthsEl = $('#masterMonths');
    let months = Number(monthsEl.value);
    const maxPass = mBody.children.length || 1;
    if (!masterMonthsTouched || !Number.isFinite(months)){ months = maxPass; monthsEl.value = months; }
    months = clamp(Math.trunc(months), 1, 12); if (String(months)!==monthsEl.value) monthsEl.value = months;

    const adjTotal = round2(baseTotal);
    $('#masterBaseTotal').textContent = fmtUSD(document.body.classList.contains('customer') ? adjTotal : round2(baseTotal));
    $('#masterAdjTotalPill').textContent = `Adjusted Total: ${fmtUSD(adjTotal)}`;
    const payments = equalPayments(adjTotal, months);
    $('#masterPaymentPill').textContent = `${months} payments of ${fmtUSD(payments[0]||0)}`;
  }catch(e){ console.error(e); }
}

/* ===== Blocks ===== */
function addNewBlock({pins=0, acres=1, collapsed=true}={}){
  const id = blockSeq++;
  const b = { id, pins:Math.trunc(pins), acres:(acres>0?acres:1), include:true, removedPasses:0, addedPasses:0, collapsed, overrides:{} };
  blocks.push(b);
  $('#blocks').insertAdjacentHTML('beforeend', blockHTML(b));
  renderAll();
}

/* ===== Events ===== */
function wireEvents(){
  $('#customerToggle').addEventListener('change', (e)=>{
    document.body.classList.toggle('customer', e.target.checked);
    renderAll();
  });

  $('#masterMonths').addEventListener('input', ()=>{ masterMonthsTouched = true; renderAll(); });
  $('#masterFloor').addEventListener('input', renderAll);
  $('#masterDpp').addEventListener('input', renderAll);

  // Edit controls (below master pass control)
  $('#editToggle').addEventListener('click', ()=>{
    editState.active = true;
    clearMasterError();
    renderAll();
  });
  $('#editBy').addEventListener('change', (e)=>{ editState.by = e.target.value; });
  $('#editCancel').addEventListener('click', ()=>{
    editState.active = false;
    clearMasterError();
    renderAll();
  });
  $('#editSave').addEventListener('click', ()=>{
    try{
      clearMasterError();
      if (editState.by==='total'){
        document.querySelectorAll('.edit-total').forEach(inp=>{
          const passIndex = Number(inp.dataset.pass);
          const val = Number(inp.value);
          if (Number.isFinite(val)) distributePassToTarget(passIndex, val);
        });
      }else{
        document.querySelectorAll('.edit-peracre').forEach(inp=>{
          const passIndex = Number(inp.dataset.pass);
          const perAcre = Number(inp.value);
          if (!Number.isFinite(perAcre)) return;
          const ctx = (function(){
            const arr=[]; for (const b of blocks){ if (!b.include) continue;
              const acres = Number(document.querySelector(`#acres-${b.id}`).value||0);
              arr.push({acres});
            } return arr;
          })();
          const sumAcres = ctx.reduce((s,x)=> s + x.acres, 0);
          distributePassToTarget(passIndex, round2(perAcre * sumAcres));
        });
      }
    }finally{
      editState.active = false;
      renderAll();
    }
  });

  // Master pass control
  $('#masterRemovePass').addEventListener('click', ()=>{ for (const b of blocks){ b.removedPasses = (b.removedPasses||0)+1; } renderAll(); });
  $('#masterAddPass').addEventListener('click',    ()=>{ for (const b of blocks){ b.addedPasses   = (b.addedPasses||0)+1;   } renderAll(); });

  // Add block
  $('#addBlockBtn').addEventListener('click', ()=> addNewBlock({pins:0, acres:1, collapsed:true}));

  // Blocks delegation
  const blocksEl = $('#blocks');
  blocksEl.addEventListener('click', (e)=>{
    if (e.target.closest('.switch')) { setTimeout(renderAll, 0); return; }
    const btn = e.target.closest('button');
    if (btn && btn.id.startsWith('addPass-')){
      const id = Number(btn.id.replace('addPass-',''));
      const b = blocks.find(x=>x.id===id); if (!b) return;
      const pins  = Math.trunc(Number($(`#pins-${id}`).value||0));
      const acres = Number($(`#acres-${id}`).value||0);
      const dppIn = $(`#dpp-${id}`).value;
      const mdpp  = Number($('#masterDpp').value||20);
      const effDpp= (dppIn!=='' && Number.isFinite(Number(dppIn))) ? Number(dppIn) : mdpp;
      const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff   = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
      if (eff < 8) b.addedPasses = (b.addedPasses||0)+1;
      renderAll(); return;
    }
    if (btn && btn.id.startsWith('removePass-')){
      const id = Number(btn.id.replace('removePass-',''));
      const b = blocks.find(x=>x.id===id); if (!b) return;
      const pins  = Math.trunc(Number($(`#pins-${id}`).value||0));
      const acres = Number($(`#acres-${id}`).value||0);
      const dppIn = $(`#dpp-${id}`).value;
      const mdpp  = Number($('#masterDpp').value||20);
      const effDpp= (dppIn!=='' && Number.isFinite(Number(dppIn))) ? Number(dppIn) : mdpp;
      const base  = calcBase(pins, Math.max(0.01, acres), effDpp);
      const eff   = clamp(base.autoCount + (b.addedPasses||0) - (b.removedPasses||0), 1, 8);
      if (eff > 1){
        if ((b.addedPasses||0)>0) b.addedPasses -= 1;
        else b.removedPasses = (b.removedPasses||0) + 1;
      }
      renderAll(); return;
    }
    const tz = e.target.closest('.toggle-zone');
    if (tz){
      const id = Number(tz.id.replace('toggle-zone-',''));
      const blockEl = document.querySelector(`.block[data-block-id="${id}"]`);
      const collapsed = blockEl.classList.toggle('collapsed');
      tz.setAttribute('aria-expanded', String(!collapsed));
      return;
    }
  });
  blocksEl.addEventListener('input', (e)=>{ if (/^(pins-|acres-|floor-|dpp-)/.test(e.target.id)) renderAll(); });
  blocksEl.addEventListener('change', (e)=>{ if (/^(pins-|acres-|floor-|dpp-|include-)/.test(e.target.id)) renderAll(); });
}

/* ===== Boot ===== */
(function start(){
  wireEvents();
  addNewBlock({ pins:400, acres:54, collapsed:false });
})();
</script>
</body>
</html>
