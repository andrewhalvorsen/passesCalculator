<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Smokin’ Burrow – JS Quoting (fixed)</title>
<style>
  :root{
    --brown:#6a4b2f; --green:#0b6b3a; --line:#e7e3df; --pill:#f3f1ee; --muted:#777;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#222;background:#fff}
  header{background:var(--brown);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px}
  header .brand{font-weight:700}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .panel{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #c8b8ac;background:var(--pill);border-radius:999px;padding:8px 12px}
  .pill input{width:110px;border:1px solid #c8b8ac;border-radius:999px;padding:6px 10px;background:#fff}
  .pill.small input{width:90px}
  .btn{cursor:pointer;border:1px solid #bda797;background:#fff;border-radius:999px;padding:8px 12px}
  .btn.small{padding:4px 8px}
  .stat{display:flex;flex-direction:column;gap:4px}
  .value{font-weight:700}
  .value.green{color:var(--green)}
  .muted{color:var(--muted)}
  .block-pill{display:flex;align-items:center;gap:10px;background:var(--pill);border:1px solid #c8b8ac;border-radius:12px;padding:10px 12px;margin:8px 0;cursor:pointer}
  .block-pill .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .block-card{border:1px solid var(--line);border-radius:12px;padding:12px;margin:-4px 0 10px 0;background:#fff}
  .hidden{display:none}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:right}
  th:nth-child(1),td:nth-child(1){text-align:center}
  th:nth-child(2),td:nth-child(2){text-align:center}
  .badge{padding:3px 10px;border-radius:999px;background:#eee;border:1px solid #ccc;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">Smokin’ Burrow</div>
</header>

<main>
  <!-- MASTER CONTROLS -->
  <section class="panel">
    <div class="row">
      <span class="pill"><label>Min $/acre</label><input id="minAcre" type="number" step="0.01" value="20"></span>
      <span class="pill"><label>$ / pin</label><input id="dpp" type="number" step="0.01" value="20"></span>
      <span class="pill small"><label>% adjust</label><input id="adjPct" type="number" step="1" value="0"></span>
      <button id="adjMinus" class="btn small">−1%</button>
      <button id="adjPlus" class="btn small">+1%</button>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="stat"><span class="muted">Total cost (base + extras)</span><span id="totalBase" class="value">$0.00</span></div>
      <div class="stat"><span class="muted">Adjusted total</span><span id="totalAdj" class="value green">$0.00</span></div>
    </div>
  </section>

  <!-- BLOCKS -->
  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="value" style="color:var(--brown)">Blocks</div>
      <button id="addBlock" class="btn">+ Add block</button>
    </div>
    <div id="blocks"></div>
  </section>
</main>

<script>
/* ========= Utilities ========= */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const roundN = (n, dp)=> Math.sign(n) * Math.round(Math.abs(n) * Math.pow(10,dp)) / Math.pow(10,dp);
const r2 = n => roundN(n, 2);
const r4 = n => roundN(n, 4);
const fmt = n => (Number.isFinite(n)? r2(n) : 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

/* ========= State ========= */
const state = {
  master: { floorPerAcre: 20, dollarsPerPin: 20, adjPct: 0 },
  blocks: [
    // demo data; your app will create these from real data
    { id:1, label:'Block 1', pins:400, acres:54, include:true, added:0, removed:0, overrides:null },
    { id:2, label:'Block 2', pins:250, acres:32.5, include:true, added:0, removed:0, overrides:null }
  ]
};

/* ========= Core math (JS mirror of your C# rules) ========= */
function passCountFromBase(basePerAcre){
  if (basePerAcre < 50) return 4;
  if (basePerAcre < 100) return 5;
  return 6; // 100 exactly -> 6
}

function computeBlock(b, master){
  const floor = master.floorPerAcre;
  const dpp = master.dollarsPerPin;
  const factor = 1 + (master.adjPct/100);

  // (1) base $/acre
  const basePerAcre = (b.pins * dpp) / Math.max(0.0000001, b.acres);
  // (2)+(3) pass count + clamp 1..8
  const auto = passCountFromBase(basePerAcre);
  const passCount = Math.min(8, Math.max(1, auto + (b.added||0) - (b.removed||0)));

  const passes = [];
  let prev = basePerAcre;
  let perAcreSum = 0, baseTot = 0, hoursTot = 0;

  for (let i=1;i<=passCount;i++){
    let rate = (i===1)? basePerAcre : prev/2;
    let floored = false;

    // If overrides exist (from Set Total), we use them EXACTLY and ignore floor
    if (b.overrides && b.overrides[i] != null){
      rate = b.overrides[i];
    } else {
      if (rate < floor){ rate = floor; floored = true; }
    }

    rate = r4(rate);
    const passBase = r2(rate * b.acres);
    const hours    = r2(passBase / 120);
    const passAdj  = r2(passBase * factor);

    passes.push({ number:i, perAcre:rate, floored, passBase, passAdjusted:passAdj, hours });

    perAcreSum += rate; baseTot += passBase; hoursTot += hours;
    prev = rate;
  }

  return {
    id:b.id, label:b.label, pins:b.pins, acres:b.acres, include:b.include!==false,
    passCount, passes,
    perAcreTotal: r2(perAcreSum),
    baseTotal: r2(baseTot),
    adjustedTotal: r2(baseTot * factor),
    hours: r2(hoursTot)
  };
}

function computeAll(){
  const master = state.master;
  const results = state.blocks.map(b => computeBlock(b, master));
  const included = results.filter(b => state.blocks.find(x=>x.id===b.id).include !== false);
  let base = 0, adj = 0;
  included.forEach(b => { base += b.baseTotal; adj += b.adjustedTotal; });
  return { masterTotals: { base:r2(base), adjusted:r2(adj) }, blocks: results };
}

/* ========= Set Total logic (overrides per-pass rates for THAT BLOCK) =========
   Target is ADJUSTED total for the block (after % adjust).
   We re-scale the *unfloored* halving series so the adjusted sum hits the target.
   This intentionally OVERRIDES both $/pin and min $/acre for that block.
*/
function setBlockTotal(blockId, targetAdjusted){
  const b = state.blocks.find(x=>x.id===blockId);
  if(!b) return;

  const factor = 1 + (state.master.adjPct/100);
  const targetBase = targetAdjusted / factor;
  const acres = Math.max(0.0000001, b.acres);

  // derive original series (UNFLOORED), based on current global $/pin
  const basePerAcre = (b.pins * state.master.dollarsPerPin) / acres;
  const auto = passCountFromBase(basePerAcre);
  const passCount = Math.min(8, Math.max(1, auto + (b.added||0) - (b.removed||0)));

  let rates = [];
  let prev = basePerAcre;
  for (let i=1;i<=passCount;i++){
    const r = (i===1)? basePerAcre : prev/2;
    rates.push(r);
    prev = r;
  }

  let sumRates = rates.reduce((a,c)=>a+c,0);
  // If starting series is all zeros (e.g., pins=0), distribute evenly
  if (sumRates <= 0.0000001){
    const each = (targetBase / acres) / passCount;
    rates = rates.map(_=>each);
  } else {
    // scale so sum(rates)*acres == targetBase
    const targetSumRates = targetBase / acres;
    const s = targetSumRates / sumRates;
    rates = rates.map(r => r4(Math.max(0, r*s))); // allow below global floor by design
  }

  // Save overrides; compute() will ignore floor when overrides exist
  b.overrides = {};
  rates.forEach((r, idx)=>{ b.overrides[idx+1] = r; });
}

/* ========= UI ========= */
function bindMaster(){
  // Top inputs: these now work and trigger recompute right away
  $('#minAcre').addEventListener('input', e=>{
    state.master.floorPerAcre = Number(e.target.value||0);
    render();
  });
  $('#dpp').addEventListener('input', e=>{
    state.master.dollarsPerPin = Number(e.target.value||0);
    render();
  });
  $('#adjPct').addEventListener('input', e=>{
    state.master.adjPct = Number(e.target.value||0);
    render();
  });
  $('#adjMinus').addEventListener('click', ()=>{
    state.master.adjPct = (state.master.adjPct||0) - 1;
    $('#adjPct').value = state.master.adjPct;
    render();
  });
  $('#adjPlus').addEventListener('click', ()=>{
    state.master.adjPct = (state.master.adjPct||0) + 1;
    $('#adjPct').value = state.master.adjPct;
    render();
  });
  $('#addBlock').addEventListener('click', ()=>{
    const nextId = (state.blocks.reduce((m,b)=>Math.max(m,b.id),0) || 0) + 1;
    state.blocks.push({ id:nextId, label:`Block ${nextId}`, pins:100, acres:10, include:true, added:0, removed:0, overrides:null });
    render();
  });
}

function render(){
  const data = computeAll();
  $('#totalBase').textContent = '$' + fmt(data.masterTotals.base);
  $('#totalAdj').textContent  = '$' + fmt(data.masterTotals.adjusted);

  const wrap = $('#blocks');
  wrap.innerHTML = '';

  data.blocks.forEach(b=>{
    const sb = state.blocks.find(x=>x.id===b.id);

    // pill
    const pill = document.createElement('div');
    pill.className = 'block-pill';
    pill.innerHTML = `
      <span class="value" style="color:var(--brown)">${b.label}</span>
      <span class="badge">${b.acres} ac</span>
      <span class="badge">${b.pins} pins</span>
      <div class="right">
        <label class="muted"><input type="checkbox" data-inc="${b.id}" ${sb.include!==false?'checked':''}> include</label>
        <button class="btn" data-toggle="${b.id}">open</button>
      </div>
    `;
    wrap.appendChild(pill);

    // card
    const card = document.createElement('div');
    card.className = 'block-card hidden';
    card.dataset.id = b.id;
    card.innerHTML = `
      <div class="row" style="margin-bottom:6px">
        <span class="pill small">Pins <input type="number" step="1" min="0" value="${sb.pins}" data-pins="${b.id}"></span>
        <span class="pill small">Acres <input type="number" step="0.01" min="0.01" value="${sb.acres}" data-acres="${b.id}"></span>
        <span class="pill small">Set total $ <input type="number" step="1" min="0" placeholder="e.g. 2000" data-settotal="${b.id}"></span>
        <button class="btn" data-applytotal="${b.id}">Apply</button>
        ${sb.overrides? '<button class="btn" data-clearov="'+b.id+'">Clear override</button>':''}
        <span class="muted">${sb.overrides? 'Override active (ignores min $/acre and $/pin for this block)' : ''}</span>
      </div>
      <div class="row muted" style="margin-bottom:4px">
        <span>Passes: ${b.passCount}</span>
        <span>Base total: $${fmt(b.baseTotal)}</span>
        <span>Adjusted: $${fmt(b.adjustedTotal)}</span>
        <span>Hours: ${fmt(b.hours)}</span>
      </div>
      <div class="pass-table-wrap">
        <table>
          <thead><tr><th>#</th><th>$ / acre</th><th>Floored</th><th>Pass total</th><th>Adj total</th><th>Hours</th></tr></thead>
          <tbody>
            ${b.passes.map(p=>`
              <tr>
                <td>${p.number}</td>
                <td>$${fmt(p.perAcre)}</td>
                <td>${p.floored ? 'yes' : 'no'}</td>
                <td>$${fmt(p.passBase)}</td>
                <td>$${fmt(p.passAdjusted)}</td>
                <td>${fmt(p.hours)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;
    wrap.appendChild(card);

    // events
    pill.querySelector(`[data-toggle="${b.id}"]`).onclick = ()=> card.classList.toggle('hidden');
    pill.querySelector(`[data-inc="${b.id}"]`).onchange = (e)=>{ sb.include = e.target.checked; render(); };

    card.querySelector(`[data-pins="${b.id}"]`).oninput  = e=>{ sb.pins  = Math.max(0, Number(e.target.value||0)); if(!sb.overrides) render(); };
    card.querySelector(`[data-acres="${b.id}"]`).oninput = e=>{ sb.acres = Math.max(0.01, Number(e.target.value||0.01)); if(!sb.overrides) render(); };

    const applyBtn = card.querySelector(`[data-applytotal="${b.id}"]`);
    const setTotalInput = card.querySelector(`[data-settotal="${b.id}"]`);
    applyBtn.onclick = ()=>{
      const target = Number(setTotalInput.value||0);
      if(target<=0){ alert('Enter a positive total.'); return; }
      setBlockTotal(b.id, target); // overrides min $/acre and $/pin FOR THIS BLOCK
      render();
    };

    const clr = card.querySelector(`[data-clearov="${b.id}"]`);
    if (clr) clr.onclick = ()=>{ sb.overrides = null; render(); };
  });
}

/* init */
bindMaster();
render();
</script>
</body>
</html>
