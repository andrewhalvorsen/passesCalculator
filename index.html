<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pass Pricing — Blocks with Floors, $/Pin & Adjustment</title>
<style>
  :root{--yellow:#fff36a;--gray:#d9d9d9;--ink:#111827;--accent:#2563eb;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:#f8fafc;color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;background:#fff;border:1px solid var(--border);
        border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .bar{background:var(--gray);padding:8px 16px;font-weight:700;letter-spacing:.08em;color:#444;
       display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .bar .right{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .header{background:var(--yellow);padding:18px 16px;text-align:center;border-bottom:2px solid var(--border)}
  .header h1{margin:0;font-size:28px;font-weight:800}
  .card{border-top:1px solid var(--border)}
  .card-head{padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .pill{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600}
  .inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;padding:0 16px 16px;background:#fff}
  .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
  .field label{display:block;font-size:12px;color:#6b7280;letter-spacing:.04em;margin-bottom:6px}
  .field input{width:100%;font-size:18px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;outline:none}
  .field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .hint{font-size:11px;color:#6b7280;margin-top:6px}
  .row-controls{display:grid;grid-template-columns:1fr auto auto;gap:8px}
  .grid{width:100%;border-collapse:collapse;margin:8px 0 16px}
  .grid th,.grid td{border:1px solid var(--border);padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums}
  .grid th:first-child,.grid td:first-child{text-align:center}
  .grid thead th{background:#eef2ff;font-weight:700}
  .grid tfoot td{background:#f3f4f6;font-weight:700}
  .row-hi{background:var(--yellow)}
  .notice{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;display:none;margin:0 16px 12px}
  .foot{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 16px;border-top:2px solid var(--border);background:#fff;flex-wrap:wrap}
  .payments{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
  .blocks{padding:0 16px 24px}
  .block{border:1px solid var(--border);border-radius:12px;margin:16px 0;overflow:hidden;transition:opacity .2s ease, filter .2s ease}
  .block .title{background:#f3f4f6;padding:10px 12px;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .title-left{display:flex;align-items:center;gap:12px}
  .title-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .muted{color:#6b7280}
  .inactive{opacity:.55; filter:grayscale(0.4)}
  .switch{display:flex;align-items:center;gap:6px;font-size:12px}
  .adj-row{display:flex;align-items:center;gap:8px}
  .adj-row .btn{padding:6px 10px}
  .inline-note{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div>NAME</div>
    <div class="right">
      <span class="pill" id="blockCountPill">Blocks: 1 (active 1)</span>
      <button class="btn" id="addBlock">+ Add Block</button>
    </div>
  </div>

  <!-- MASTER SUMMARY (ALL INCLUDED BLOCKS) -->
  <div class="card" id="masterCard">
    <div class="header"><h1>All Blocks — Summary</h1></div>
    <div id="masterErr" class="notice"></div>
    <div class="inputs">
      <div class="field">
        <label for="masterMonths">Months (payments for ALL blocks)</label>
        <input id="masterMonths" type="number" min="1" max="12" step="1" value="" />
        <div class="hint">Auto = max pass count across <b>included</b> blocks; override 1–12.</div>
      </div>
      <div class="field">
        <label for="masterFloor">Minimum $/acre (floor)</label>
        <input id="masterFloor" type="number" min="0" step="0.01" value="20" />
        <div class="hint">Applies to all blocks unless a block sets its own override.</div>
      </div>
      <div class="field">
        <label for="masterDpp">Price per pin ($/pin)</label>
        <input id="masterDpp" type="number" min="0" step="0.01" value="20" />
        <div class="hint">Applies to all blocks unless a block sets its own override.</div>
      </div>
      <div class="field">
        <label>Total adjustment (%)</label>
        <div class="adj-row">
          <button class="btn" id="adjMinus">−1%</button>
          <input id="masterAdjPct" type="number" step="1" min="-100" max="100" value="0" style="max-width:110px" />
          <button class="btn" id="adjPlus">+1%</button>
        </div>
        <div class="hint">Applies to the grand total only; payments use the <b>adjusted</b> total.</div>
      </div>
    </div>
    <div class="card-head">
      <span class="pill" id="masterPassInfo">Passes: —</span>
      <span class="pill" id="masterAcreInfo">Total Acres (included): —</span>
      <span class="pill" id="masterTotal">Whole-field total: $—</span>
      <span class="pill" id="masterAdjTotal">Adjusted total: $— <span id="masterAdjNote" class="inline-note"></span></span>
    </div>
    <div style="padding:0 16px 0">
      <table class="grid">
        <thead>
          <tr>
            <th style="width:120px">Pass</th>
            <th>Cost / Acre (weighted)</th>
            <th>Total Cost (sum across blocks)</th>
          </tr>
        </thead>
        <tbody id="masterPassRows"></tbody>
        <tfoot>
          <tr>
            <td style="text-align:center"># of Passes</td>
            <td id="masterPassesCell" style="text-align:center" class="muted">—</td>
            <td id="masterGrandCell" style="text-align:right">$—</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="foot">
      <div class="muted">Payment plan (<span id="masterPaymentCount">—</span> equal payments):</div>
      <div class="payments" id="masterPayments"></div>
    </div>
  </div>

  <!-- BLOCKS LIST -->
  <div class="blocks" id="blocks"></div>
</div>

<script>
/*=====================  SHARED UTILS  =====================*/
const fmtUSD = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);
const round2 = v => Math.round((v + Number.EPSILON) * 100) / 100;
const clamp  = (n,min,max) => Math.min(max, Math.max(min, n));

function equalPayments(total, n){
  if (n <= 0) return [];
  const each = round2(total / n);
  const list = Array.from({length:n-1}, ()=> each);
  list.push(round2(total - list.reduce((a,b)=>a+b,0)));
  return list;
}

function calcBase(pinCount, acres, dollarsPerPin){
  if (pinCount < 0 || !Number.isFinite(pinCount)) throw new Error('Pin count must be a whole number >= 0');
  if (!(acres > 0)) throw new Error('Acres must be > 0');
  if (!(dollarsPerPin >= 0)) throw new Error('Price per pin must be >= 0');
  const basePerAcre = (pinCount * dollarsPerPin) / acres;
  const autoCount = basePerAcre < 50 ? 4 : (basePerAcre < 100 ? 5 : 6); // 100 => 6
  return { basePerAcre, autoCount };
}

function calcWithCount(pinCount, acres, passCount, floorPerAcre, dollarsPerPin){
  const { basePerAcre } = calcBase(pinCount, acres, dollarsPerPin); // includes validation
  const passes = [];
  let prev = basePerAcre;
  for (let i=1;i<=passCount;i++){
    let rate = (i===1) ? basePerAcre : (prev/2);
    let floored = false;
    if (rate < floorPerAcre){ rate = floorPerAcre; floored = true; }
    prev = rate; // halving uses the floored value
    passes.push({ number:i, perAcre:rate, floored });
  }
  const perAcreTotal = passes.reduce((s,p)=>s+p.perAcre,0);
  const fieldTotal   = round2(perAcreTotal * acres);
  return { basePerAcre, passCount, passes, perAcreTotal, fieldTotal };
}

/*=====================  STATE  =====================*/
let blocks = []; // each: {id, pins, acres, include, removedPasses, monthsTouched, monthsVal, floorTouched, floorVal, dppTouched, dppVal}
let masterMonthsTouched = false;
let blockSeq = 1;

// initial block
addBlock({ pins:400, acres:54 });

/*=====================  DOM BUILDERS  =====================*/
function blockTemplate(b){
  const el = document.createElement('div');
  el.className = 'block';
  el.dataset.blockId = b.id;

  el.innerHTML = `
    <div class="title">
      <div class="title-left">
        <div>Block ${b.id}</div>
        <label class="switch">
          <input type="checkbox" id="include-${b.id}" ${b.include ? 'checked' : ''}>
          <span>Include in totals</span>
        </label>
      </div>
      <div class="title-right">
        <span class="muted" id="effectiveFloor-${b.id}"></span>
        <span class="muted" id="effectiveDpp-${b.id}"></span>
      </div>
    </div>

    <div id="err-${b.id}" class="notice"></div>

    <div class="inputs">
      <div class="field">
        <label for="pins-${b.id}">Pin Count (whole number)</label>
        <input id="pins-${b.id}" type="number" min="0" step="1" value="${b.pins}" />
      </div>
      <div class="field">
        <label for="acres-${b.id}">Acres (fractional allowed)</label>
        <input id="acres-${b.id}" type="number" min="0" step="0.01" value="${b.acres}" />
      </div>
      <div class="field">
        <label for="months-${b.id}">Months (payments)</label>
        <input id="months-${b.id}" type="number" min="1" max="12" step="1" value="" />
        <div class="hint">Auto = this block's pass count; override 1–12.</div>
      </div>
      <div class="field">
        <label for="floor-${b.id}">Min $/acre (optional override)</label>
        <input id="floor-${b.id}" type="number" min="0" step="0.01" value="" placeholder="">
        <div class="hint">Leave blank to use master floor.</div>
      </div>
      <div class="field">
        <label for="dpp-${b.id}">$ per pin (optional override)</label>
        <input id="dpp-${b.id}" type="number" min="0" step="0.01" value="" placeholder="">
        <div class="hint">Leave blank to use master $/pin.</div>
      </div>
      <div class="field">
        <label>Passes (auto, can remove)</label>
        <div class="row-controls">
          <input id="passesDisplay-${b.id}" type="text" value="" readonly />
          <button class="btn" id="removePass-${b.id}">Remove 1 Pass</button>
          <button class="btn" id="resetPasses-${b.id}">Reset Passes</button>
        </div>
        <div class="hint">Defaults to 4/5/6 by math. You can remove passes (min 1).</div>
      </div>
    </div>

    <div class="card-head">
      <span class="pill" id="base-${b.id}">Base: $— / acre</span>
      <span class="pill" id="passcount-${b.id}">Passes: —</span>
      <span class="pill" id="total-${b.id}">Whole-field total: $—</span>
    </div>

    <div style="padding:0 16px 0">
      <table class="grid">
        <thead>
          <tr>
            <th style="width:120px">Pass</th>
            <th>Cost / Acre</th>
            <th>Total Cost (this pass × acres)</th>
          </tr>
        </thead>
        <tbody id="rows-${b.id}"></tbody>
        <tfoot>
          <tr>
            <td style="text-align:center"># of Passes</td>
            <td id="passesCell-${b.id}" class="muted" style="text-align:center">—</td>
            <td id="grandCell-${b.id}" style="text-align:right">$—</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="foot">
      <div class="muted">Payment plan (<span id="paycount-${b.id}">—</span> equal payments):</div>
      <div class="payments" id="payments-${b.id}"></div>
    </div>
  `;
  return el;
}

/*=====================  RENDERING  =====================*/
function renderAll(){
  // master inputs
  let masterFloor = Number(document.getElementById('masterFloor').value);
  if (!(masterFloor >= 0)) masterFloor = 20;
  masterFloor = round2(masterFloor);

  let masterDpp = Number(document.getElementById('masterDpp').value);
  if (!(masterDpp >= 0)) masterDpp = 20;
  masterDpp = round2(masterDpp);

  let masterAdjPct = Number(document.getElementById('masterAdjPct').value);
  if (!Number.isFinite(masterAdjPct)) masterAdjPct = 0;
  masterAdjPct = clamp(Math.trunc(masterAdjPct), -100, 100);

  // Render blocks; collect data for master from INCLUDED blocks only
  const masterRows = []; // index -> {total, acres}
  let totalActiveAcres = 0;
  let activeBlocks = 0;

  blocks.forEach(b=>{
    const blockEl = document.querySelector(`.block[data-block-id="${b.id}"]`);
    const includeChk = document.getElementById(`include-${b.id}`);
    b.include = !!includeChk?.checked;
    blockEl.classList.toggle('inactive', !b.include);

    const err = document.getElementById(`err-${b.id}`);
    try{
      err.style.display = 'none';

      const pins  = Math.trunc(Number(document.getElementById(`pins-${b.id}`).value));
      const acres = Number(document.getElementById(`acres-${b.id}`).value);

      // floor override
      const floorInput = document.getElementById(`floor-${b.id}`);
      let floorVal = Number(floorInput.value);
      let hasFloorOverride = Number.isFinite(floorVal) && floorInput.value !== '';
      if (!hasFloorOverride) floorVal = masterFloor;
      floorVal = clamp(round2(floorVal), 0, 1e9);
      document.getElementById(`effectiveFloor-${b.id}`).textContent = `Floor: ${fmtUSD(floorVal)}/acre`;
      floorInput.placeholder = `${masterFloor}`;

      // $/pin override
      const dppInput = document.getElementById(`dpp-${b.id}`);
      let dppVal = Number(dppInput.value);
      let hasDppOverride = Number.isFinite(dppVal) && dppInput.value !== '';
      if (!hasDppOverride) dppVal = masterDpp;
      dppVal = clamp(round2(dppVal), 0, 1e9);
      document.getElementById(`effectiveDpp-${b.id}`).textContent = `$/pin: ${fmtUSD(dppVal)}`;
      dppInput.placeholder = `${masterDpp}`;

      // base + auto passes (use effective $/pin)
      const base = calcBase(pins, acres, dppVal);
      b.removedPasses = clamp(b.removedPasses, 0, base.autoCount-1);
      const effPasses = clamp(base.autoCount - b.removedPasses, 1, 99);

      // months sync
      const monthsInput = document.getElementById(`months-${b.id}`);
      let monthsVal = Number(monthsInput.value);
      if (!b.monthsTouched || !Number.isFinite(monthsVal)){ monthsVal = effPasses; monthsInput.value = monthsVal; }
      monthsVal = clamp(Math.trunc(monthsVal), 1, 12);
      if (monthsInput.value !== String(monthsVal)) monthsInput.value = monthsVal;
      b.monthsVal = monthsVal;

      // full calc
      const q = calcWithCount(pins, acres, effPasses, floorVal, dppVal);

      // pills
      document.getElementById(`base-${b.id}`).textContent = `Base: ${fmtUSD(round2(base.basePerAcre))} / acre`;
      document.getElementById(`passcount-${b.id}`).textContent = `Passes: ${q.passCount}` + (b.removedPasses ? ` (auto ${base.autoCount}, removed ${b.removedPasses})` : '');
      document.getElementById(`total-${b.id}`).textContent = `Whole-field total: ${fmtUSD(q.fieldTotal)}`;

      // rows
      const tbody = document.getElementById(`rows-${b.id}`); tbody.innerHTML='';
      q.passes.forEach(p=>{
        const tr = document.createElement('tr');
        if (p.number===1) tr.classList.add('row-hi');
        const td1 = document.createElement('td'); td1.style.textAlign='center'; td1.textContent=`Pass ${p.number}` + (p.floored?' *':'');
        const td2 = document.createElement('td'); td2.textContent=fmtUSD(round2(p.perAcre));
        const td3 = document.createElement('td'); td3.textContent=fmtUSD(round2(p.perAcre * acres));
        tr.append(td1,td2,td3); tbody.appendChild(tr);

        // accumulate into master if included
        if (b.include){
          const idx = p.number - 1;
          masterRows[idx] = masterRows[idx] || { total:0, acres:0 };
          masterRows[idx].total += round2(p.perAcre * acres);
          masterRows[idx].acres += acres;
        }
      });

      document.getElementById(`passesCell-${b.id}`).textContent = q.passCount;
      document.getElementById(`grandCell-${b.id}`).textContent  = fmtUSD(q.fieldTotal);

      // payments (per-block)
      document.getElementById(`paycount-${b.id}`).textContent = monthsVal;
      const payWrap = document.getElementById(`payments-${b.id}`); payWrap.innerHTML='';
      equalPayments(q.fieldTotal, monthsVal).forEach((amt,i)=>{
        const chip = document.createElement('div'); chip.className='chip';
        chip.textContent = `Payment ${i+1}: ${fmtUSD(amt)}`;
        payWrap.appendChild(chip);
      });

      // controls
      document.getElementById(`passesDisplay-${b.id}`).value = `${q.passCount} (auto ${base.autoCount})`;
      document.getElementById(`removePass-${b.id}`).disabled = q.passCount <= 1;

      if (b.include){ totalActiveAcres += acres; activeBlocks++; }
    }catch(e){
      err.style.display = 'block';
      err.textContent = e.message;
    }
  });

  // MASTER render
  const maxPass = masterRows.length; // highest pass among included blocks
  document.getElementById('blockCountPill').textContent = `Blocks: ${blocks.length} (active ${activeBlocks})`;

  // master months (auto = maxPass unless overridden)
  const masterMonthsInput = document.getElementById('masterMonths');
  let mVal = Number(masterMonthsInput.value);
  if (!masterMonthsTouched || !Number.isFinite(mVal)){ mVal = maxPass || 1; masterMonthsInput.value = mVal; }
  mVal = clamp(Math.trunc(mVal), 1, 12);
  if (masterMonthsInput.value !== String(mVal)) masterMonthsInput.value = mVal;

  // build master table + totals (pre-adjustment)
  const mBody = document.getElementById('masterPassRows'); mBody.innerHTML='';
  let masterTotal = 0;

  for (let i=0;i<masterRows.length;i++){
    const row = masterRows[i];
    if (!row) continue;
    const weightedPerAcre = row.acres > 0 ? round2(row.total / row.acres) : 0;
    masterTotal += row.total;

    const tr = document.createElement('tr');
    if (i===0) tr.classList.add('row-hi');
    const td1 = document.createElement('td'); td1.style.textAlign='center'; td1.textContent = `Pass ${i+1}`;
    const td2 = document.createElement('td'); td2.textContent = fmtUSD(weightedPerAcre);
    const td3 = document.createElement('td'); td3.textContent = fmtUSD(round2(row.total));
    tr.append(td1,td2,td3); mBody.appendChild(tr);
  }

  // base totals (pre-adjust)
  const baseTotal = round2(masterTotal);
  document.getElementById('masterPassInfo').textContent = `Passes: ${maxPass || '—'}`;
  document.getElementById('masterAcreInfo').textContent = `Total Acres (included): ${round2(totalActiveAcres)}`;
  document.getElementById('masterPassesCell').textContent = maxPass || '—';
  document.getElementById('masterGrandCell').textContent  = fmtUSD(baseTotal);
  document.getElementById('masterTotal').textContent      = `Whole-field total: ${fmtUSD(baseTotal)}`;

  // adjustment & payments
  const adjFactor = 1 + (masterAdjPct/100);
  const adjTotal  = round2(baseTotal * adjFactor);
  document.getElementById('masterAdjTotal').textContent = `Adjusted total: ${fmtUSD(adjTotal)} `;
  document.getElementById('masterAdjNote').textContent  = masterAdjPct === 0 ? '(no adj)' : `(${masterAdjPct > 0 ? '+' : ''}${masterAdjPct}%)`;

  document.getElementById('masterPaymentCount').textContent = mVal;
  const mp = document.getElementById('masterPayments'); mp.innerHTML='';
  equalPayments(adjTotal, mVal).forEach((amt,i)=>{
    const chip = document.createElement('div'); chip.className='chip';
    chip.textContent = `Payment ${i+1}: ${fmtUSD(amt)}`; mp.appendChild(chip);
  });
}

/*=====================  BLOCK MANAGEMENT  =====================*/
function addBlock({pins=0, acres=1}={}){
  const id = blockSeq++;
  const b = {
    id, pins, acres,
    include:true,
    removedPasses:0,
    monthsTouched:false, monthsVal:null,
    floorTouched:false, floorVal:null,
    dppTouched:false, dppVal:null
  };
  blocks.push(b);

  const el = blockTemplate(b);
  document.getElementById('blocks').appendChild(el);

  // wire events
  const evs = ['input','change'];
  evs.forEach(e=>{
    document.getElementById(`pins-${id}`).addEventListener(e, renderAll);
    document.getElementById(`acres-${id}`).addEventListener(e, renderAll);
    document.getElementById(`floor-${id}`).addEventListener(e, ()=>{ b.floorTouched = true; renderAll(); });
    document.getElementById(`dpp-${id}`).addEventListener(e,   ()=>{ b.dppTouched   = true; renderAll(); });
  });
  document.getElementById(`months-${id}`).addEventListener('input', ()=>{ b.monthsTouched = true; renderAll(); });
  document.getElementById(`months-${id}`).addEventListener('change', ()=>{ b.monthsTouched = true; renderAll(); });
  document.getElementById(`removePass-${id}`).addEventListener('click', ()=>{ b.removedPasses += 1; renderAll(); });
  document.getElementById(`resetPasses-${id}`).addEventListener('click', ()=>{ b.removedPasses = 0; renderAll(); });
  document.getElementById(`include-${id}`).addEventListener('change', renderAll);

  // initial values in inputs
  document.getElementById(`pins-${id}`).value  = pins;
  document.getElementById(`acres-${id}`).value = acres;

  renderAll();
}

/*=====================  GLOBAL CONTROLS  =====================*/
document.getElementById('addBlock').addEventListener('click', ()=> addBlock({pins:0, acres:1}));
document.getElementById('masterMonths').addEventListener('input', ()=>{ masterMonthsTouched = true; renderAll(); });
document.getElementById('masterMonths').addEventListener('change', ()=>{ masterMonthsTouched = true; renderAll(); });
document.getElementById('masterFloor').addEventListener('input', renderAll);
document.getElementById('masterFloor').addEventListener('change', renderAll);
document.getElementById('masterDpp').addEventListener('input', renderAll);
document.getElementById('masterDpp').addEventListener('change', renderAll);
document.getElementById('masterAdjPct').addEventListener('input', renderAll);
document.getElementById('masterAdjPct').addEventListener('change', renderAll);
document.getElementById('adjMinus').addEventListener('click', ()=>{
  const i = document.getElementById('masterAdjPct');
  i.value = clamp((Number(i.value)||0)-1, -100, 100);
  renderAll();
});
document.getElementById('adjPlus').addEventListener('click', ()=>{
  const i = document.getElementById('masterAdjPct');
  i.value = clamp((Number(i.value)||0)+1, -100, 100);
  renderAll();
});

/*=====================  BOOT  =====================*/
renderAll();
</script>
</body>
</html>
